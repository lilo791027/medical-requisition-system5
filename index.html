<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸Šå‰é†«ç™‚-è—¥å“é†«æè«‹è³¼ç³»çµ±</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* æ‚¨çš„CSSä»£ç¢¼ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* ç™»å…¥é é¢ */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .login-form {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        .login-form h1 {
            color: #333;
            margin-bottom: 30px;
            font-size: 24px;
        }

        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: bold;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .login-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .login-btn:hover {
            transform: translateY(-2px);
        }

        /* ä¸»ç³»çµ±ä»‹é¢ */
        .main-system {
            display: none;
        }

        .header {
            background: white;
            padding: 15px 30px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: #333;
            font-size: 24px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logout-btn {
            padding: 8px 16px;
            background: #ff4757;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .logout-btn:hover {
            background: #ff3742;
        }

        .nav-menu {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .nav-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
        }

        .nav-btn {
            padding: 12px 24px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
            position: relative;
        }

        .nav-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        }

        .nav-btn.active {
            background: linear-gradient(135deg, #2f3542, #40407a);
        }

        .notification-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #ff4757;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .content-area {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            min-height: 600px;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        /* è¡¨å–®æ¨£å¼ */
        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-col {
            flex: 1;
        }

        .form-col label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }

        .form-col input,
        .form-col select,
        .form-col textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .form-col textarea {
            height: 80px;
            resize: vertical;
        }

        /* æŒ‰éˆ•æ¨£å¼ */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-success {
            background: #2ed573;
            color: white;
        }

        .btn-danger {
            background: #ff4757;
            color: white;
        }

        .btn-secondary {
            background: #57606f;
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        /* è¡¨æ ¼æ¨£å¼ */
        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .table th,
        .table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .table th {
            background: #f8f9fa;
            font-weight: bold;
            color: #333;
        }

        .table tr:hover {
            background: #f8f9fa;
        }

        /* å“é …è¡¨æ ¼ */
        .items-table {
            margin-top: 20px;
            border: 2px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
        }

        .items-table th {
            background: #667eea;
            color: white;
        }

        /* ä¸‹æ‹‰é¸å–® */
        .dropdown {
            position: relative;
            display: inline-block;
            margin-bottom: 20px;
        }

        .dropdown-btn {
            background: #667eea;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .dropdown-content {
            display: none;
            position: absolute;
            background: white;
            min-width: 160px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
            border-radius: 5px;
            z-index: 1;
        }

        .dropdown-content.show {
            display: block;
        }

        .dropdown-content a {
            color: #333;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
            transition: background 0.3s;
        }

        .dropdown-content a:hover {
            background: #f1f1f1;
        }

        /* ç‹€æ…‹æ¨™ç±¤ */
        .status-badge {
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
        }

        .status-pending {
            background: #ffa726;
            color: white;
        }

        .status-approved {
            background: #66bb6a;
            color: white;
        }

        .status-rejected {
            background: #ef5350;
            color: white;
        }

        /* æœå°‹æ¡† */
        .search-box {
            width: 300px;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 25px;
            margin-bottom: 20px;
        }

        /* åº«å­˜ç®¡ç† */
        .inventory-stats {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            flex: 1;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-card h3 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .stat-card p {
            opacity: 0.9;
        }

        /* æª”æ¡ˆä¸Šå‚³ */
        .file-upload {
            border: 2px dashed #ddd;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            margin-bottom: 20px;
            transition: all 0.3s;
        }

        .file-upload:hover {
            border-color: #667eea;
            background: #f8f9fa;
        }

        .file-upload input[type="file"] {
            display: none;
        }

        /* å‹¾é¸æ¡†æ¨£å¼ */
        .approved-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
            transform: scale(1.2);
        }

        .approved-checkbox:checked {
            accent-color: #667eea;
        }

        /* é¸æ“‡æ“ä½œå€åŸŸ */
        .selection-controls {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #dee2e6;
        }

        .selection-controls h4 {
            margin: 0 0 10px 0;
            color: #333;
        }

        /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
        @media (max-width: 768px) {
            .nav-buttons {
                flex-direction: column;
            }

            .form-row {
                flex-direction: column;
            }

            .inventory-stats {
                flex-direction: column;
            }

            .table {
                font-size: 12px;
            }

            .table th,
            .table td {
                padding: 8px;
            }

            .selection-controls {
                text-align: center;
            }

            .selection-controls .btn {
                margin: 5px;
                width: 100%;
            }
        }

        /* æ¨¡æ…‹æ¡† */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #000;
        }

        .section-divider {
            border-top: 2px solid #eee;
            margin: 30px 0;
            padding-top: 20px;
        }

        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-danger {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        /* ä¸Šå‚³ç‹€æ…‹æ¨£å¼ */
        .upload-status {
            margin-bottom: 20px;
        }

        .status-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
            padding: 10px;
            border-radius: 5px;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            padding: 10px;
            border-radius: 5px;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            padding: 10px;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div id="loginPage" class="login-container">
        <div class="login-form">
            <h1>ğŸ¥ ä¸Šå‰é†«ç™‚<br>è—¥å“é†«æè«‹è³¼ç³»çµ±</h1>
            <div class="form-group">
                <label for="username">å¸³è™Ÿ</label>
                <input type="text" id="username" placeholder="è«‹è¼¸å…¥å¸³è™Ÿ">
            </div>
            <div class="form-group">
                <label for="password">å¯†ç¢¼</label>
                <input type="password" id="password" placeholder="è«‹è¼¸å…¥å¯†ç¢¼">
            </div>
            <button class="login-btn" type="button" onclick="login()">ç™»å…¥ç³»çµ±</button>
        </div>
    </div>

    <div id="mainSystem" class="main-system">
        <div class="container">
            <div class="header">
                <h1>ğŸ¥ ä¸Šå‰é†«ç™‚ - è—¥å“é†«æè«‹è³¼ç³»çµ±</h1>
                <div class="user-info">
                    <span>æ­¡è¿ï¼Œ<span id="currentUser"></span></span>
                    <button class="logout-btn" onclick="logout()">ç™»å‡º</button>
                </div>
            </div>

            <div class="nav-menu">
                <div class="nav-buttons">
                    <button class="nav-btn active" onclick="showPage('newProcurement')">ğŸ“ æ–°å¢è«‹è³¼</button>
                    <button class="nav-btn" onclick="showPage('approvalManagement')" id="approvalBtn">
                        âœ… ç°½æ ¸ç®¡ç†
                        <span class="notification-badge" id="pendingCount" style="display: none;">0</span>
                    </button>
                    <button class="nav-btn" onclick="showPage('approved')">âœ”ï¸ å·²æ ¸å‡†</button>
                    <button class="nav-btn" onclick="showPage('rejected')">ğŸš« å·²é§å›</button>
                    <button class="nav-btn" onclick="showPage('createPurchase')">ğŸ“ å»ºç«‹æ¡è³¼å–®</button>
                    <button class="nav-btn" onclick="showPage('inventory')">ğŸ“¦ åº«å­˜ç®¡ç†</button>
                    <button class="nav-btn" onclick="showPage('systemAdmin')">ğŸ› ï¸ ç³»çµ±ç®¡ç†</button>
                </div>
            </div>

            <div class="content-area">
                <div id="newProcurement" class="page active">
                    <h2>ğŸ“ æ–°å¢è«‹è³¼å–®</h2>
                    <form id="procurementForm">
                        <div class="form-row">
                            <div class="form-col">
                                <label>è«‹è³¼å–®è™Ÿ</label>
                                <input type="text" id="procurementNo" readonly>
                            </div>
                            <div class="form-col">
                                <label>ç”³è«‹æ—¥æœŸ</label>
                                <input type="date" id="applyDate">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-col">
                                <label>ç”³è«‹éƒ¨é–€</label>
                                <select id="department">
                                    <option value="">è«‹é¸æ“‡éƒ¨é–€</option>
                                    <option value="å…§ç§‘">å…§ç§‘</option>
                                    <option value="å¤–ç§‘">å¤–ç§‘</option>
                                    <option value="æ€¥è¨ºç§‘">æ€¥è¨ºç§‘</option>
                                    <option value="è—¥åŠ‘ç§‘">è—¥åŠ‘ç§‘</option>
                                    <option value="è­·ç†éƒ¨">è­·ç†éƒ¨</option>
                                    <option value="è¡Œæ”¿éƒ¨">è¡Œæ”¿éƒ¨</option>
                                </select>
                            </div>
                            <div class="form-col">
                                <label>ç”³è«‹äººå§“å</label>
                                <input type="text" id="applicantName">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-col">
                                <label>è«‹è³¼äº‹ç”±</label>
                                <textarea id="procurementReason" placeholder="è«‹è©³ç´°èªªæ˜è«‹è³¼äº‹ç”±..."></textarea>
                            </div>
                        </div>
                       
                        <h3>è«‹è³¼å“é …</h3>
                        <button type="button" class="btn btn-primary" onclick="addItem()">â• æ–°å¢å“é …</button>
                       
                        <table class="table items-table" id="itemsTable">
                            <thead>
                                <tr>
                                    <th>é¡åˆ¥</th>
                                    <th>åç¨±</th>
                                    <th>è¦æ ¼</th>
                                    <th>æ•¸é‡</th>
                                    <th>å–®ä½</th>
                                    <th>é ä¼°å–®åƒ¹</th>
                                    <th>å°è¨ˆ</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="itemsTableBody">
                            </tbody>
                        </table>
                       
                        <div style="margin-top: 20px; text-align: right;">
                            <strong>ç¸½é‡‘é¡ï¼šNT$ <span id="totalAmount">0</span></strong>
                        </div>
                       
                        <div style="margin-top: 30px;">
                            <button type="button" class="btn btn-success" onclick="submitProcurement()">ğŸ“¤ æäº¤è«‹è³¼å–®</button>
                            <button type="button" class="btn btn-secondary" onclick="resetForm()">ğŸ”„ é‡è¨­</button>
                        </div>
                    </form>
                </div>

                <div id="approvalManagement" class="page">
                    <h2>âœ… ç°½æ ¸ç®¡ç†</h2>
                   
                    <div class="dropdown">
                        <button class="dropdown-btn" onclick="toggleDropdown('approvalDropdown')">
                            é¸æ“‡å–®æ“šé¡å‹ â–¼
                        </button>
                        <div class="dropdown-content" id="approvalDropdown">
                            <a href="#" onclick="showApprovalType('procurement')">1. è«‹è³¼å–®</a>
                            <a href="#" onclick="showApprovalType('purchase')">2. æ¡è³¼å–®</a>
                        </div>
                    </div>

                    <div id="procurementApproval" class="section-divider">
                        <h3>å¾…å¯©æ ¸è«‹è³¼å–®</h3>
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>è«‹è³¼å–®è™Ÿ</th>
                                    <th>ç”³è«‹æ—¥æœŸ</th>
                                    <th>ç”³è«‹éƒ¨é–€</th>
                                    <th>ç”³è«‹äºº</th>
                                    <th>ç‹€æ…‹</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="pendingProcurementTable">
                                </tbody>
                        </table>
                    </div>

                    <div id="purchaseApproval" class="section-divider" style="display: none;">
                        <h3>å¾…å¯©æ ¸æ¡è³¼å–®</h3>
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>æ¡è³¼å–®è™Ÿ</th>
                                    <th>æ¡è³¼æ—¥æœŸ</th>
                                    <th>ä¾›æ‡‰å•†</th>
                                    <th>ç¸½é‡‘é¡</th>
                                    <th>ç‹€æ…‹</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="pendingPurchaseTable">
                                </tbody>
                        </table>
                    </div>
                </div>

                <div id="approved" class="page">
                    <h2>âœ”ï¸ å·²æ ¸å‡†</h2>
                   
                    <div class="dropdown">
                        <button class="dropdown-btn" onclick="toggleDropdown('approvedDropdown')">
                            é¸æ“‡å–®æ“šé¡å‹ â–¼
                        </button>
                        <div class="dropdown-content" id="approvedDropdown">
                            <a href="#" onclick="showApprovedType('procurement')">1. è«‹è³¼å–®</a>
                            <a href="#" onclick="showApprovedType('purchase')">2. æ¡è³¼å–®</a>
                        </div>
                    </div>

                    <div style="margin: 20px 0;">
                        <button class="btn btn-primary" onclick="downloadAllApproved()">ğŸ’¾ å…¨éƒ¨ä¸‹è¼‰è«‹è³¼å–®</button>
                    </div>

                    <div id="approvedProcurementSection">
                        <h3>å·²æ ¸å‡†è«‹è³¼å–®</h3>
                       
                        <div class="selection-controls">
                            <h4>ğŸ“ æ‰¹é‡å»ºç«‹æ¡è³¼å–®</h4>
                            <div style="display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                                <button class="btn btn-success" onclick="createPurchaseFromSelected()">
                                    ğŸ“ å»ºç«‹æ¡è³¼å–® (<span id="selectedCount">0</span> é …)
                                </button>
                                <button class="btn btn-secondary" onclick="selectAllApproved()">â˜‘ï¸ å…¨é¸</button>
                                <button class="btn btn-secondary" onclick="clearAllApproved()">â˜ æ¸…é™¤</button>
                                <button class="btn btn-primary" onclick="previewSelectedItems()">ğŸ‘ï¸ é è¦½é¸æ“‡</button>
                            </div>
                            <div class="selection-info" id="selectionInfo">
                                è«‹å‹¾é¸è¦å»ºç«‹æ¡è³¼å–®çš„è«‹è³¼é …ç›®ï¼Œå¯ä»¥å¤šé¸
                            </div>
                        </div>
                       
                        <table class="table">
                            <thead>
                                <tr>
                                    <th style="width: 60px;">
                                        <input type="checkbox" id="selectAllCheckbox" onchange="toggleAllApproved()" style="transform: scale(1.2);">
                                        <br><small>å…¨é¸</small>
                                    </th>
                                    <th>è«‹è³¼å–®è™Ÿ</th>
                                    <th>ç”³è«‹æ—¥æœŸ</th>
                                    <th>ç”³è«‹éƒ¨é–€</th>
                                    <th>ç”³è«‹äºº</th>
                                    <th>ç¸½é‡‘é¡</th>
                                    <th>æ ¸å‡†äºº</th>
                                    <th>æ ¸å‡†æ™‚é–“</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="approvedProcurementTable">
                                </tbody>
                        </table>
                    </div>

                    <div id="approvedPurchaseSection" style="display: none;">
                        <h3>å·²æ ¸å‡†æ¡è³¼å–®</h3>
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>æ¡è³¼å–®è™Ÿ</th>
                                    <th>æ¡è³¼æ—¥æœŸ</th>
                                    <th>ä¾›æ‡‰å•†</th>
                                    <th>ç¸½é‡‘é¡</th>
                                    <th>æ ¸å‡†äºº</th>
                                    <th>æ ¸å‡†æ™‚é–“</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="approvedPurchaseTable">
                                </tbody>
                        </table>
                    </div>
                </div>

                <div id="rejected" class="page">
                    <h2>ğŸš« å·²é§å›</h2>
                   
                    <div class="dropdown">
                        <button class="dropdown-btn" onclick="toggleDropdown('rejectedDropdown')">
                            é¸æ“‡å–®æ“šé¡å‹ â–¼
                        </button>
                        <div class="dropdown-content" id="rejectedDropdown">
                            <a href="#" onclick="showRejectedType('procurement')">1. è«‹è³¼å–®</a>
                            <a href="#" onclick="showRejectedType('purchase')">2. æ¡è³¼å–®</a>
                        </div>
                    </div>

                    <div id="rejectedProcurementSection">
                        <h3>å·²é§å›è«‹è³¼å–®</h3>
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>è«‹è³¼å–®è™Ÿ</th>
                                    <th>ç”³è«‹æ—¥æœŸ</th>
                                    <th>ç”³è«‹éƒ¨é–€</th>
                                    <th>ç”³è«‹äºº</th>
                                    <th>é§å›äºº</th>
                                    <th>é§å›æ™‚é–“</th>
                                    <th>é§å›åŸå› </th>
                                </tr>
                            </thead>
                            <tbody id="rejectedProcurementTable">
                                </tbody>
                        </table>
                    </div>

                    <div id="rejectedPurchaseSection" style="display: none;">
                        <h3>å·²é§å›æ¡è³¼å–®</h3>
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>æ¡è³¼å–®è™Ÿ</th>
                                    <th>æ¡è³¼æ—¥æœŸ</th>
                                    <th>ä¾›æ‡‰å•†</th>
                                    <th>ç¸½é‡‘é¡</th>
                                    <th>é§å›äºº</th>
                                    <th>é§å›æ™‚é–“</th>
                                    <th>é§å›åŸå› </th>
                                </tr>
                            </thead>
                            <tbody id="rejectedPurchaseTable">
                                </tbody>
                        </table>
                    </div>
                </div>

                <div id="createPurchase" class="page">
                    <h2>ğŸ“ å»ºç«‹æ¡è³¼å–®</h2>
                    <form id="purchaseForm">
                        <div class="form-row">
                            <div class="form-col">
                                <label>æ¡è³¼å–®è™Ÿ</label>
                                <input type="text" id="purchaseNo" readonly>
                            </div>
                            <div class="form-col">
                                <label>æ¡è³¼æ—¥æœŸ</label>
                                <input type="date" id="purchaseDate">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-col">
                                <label>ä¾›æ‡‰å•†</label>
                                <select id="supplier">
                                    <option value="">è«‹é¸æ“‡ä¾›æ‡‰å•†</option>
                                    <option value="å°ç£é†«æå…¬å¸">å°ç£é†«æå…¬å¸</option>
                                    <option value="åº·å¥é†«ç™‚å™¨æ">åº·å¥é†«ç™‚å™¨æ</option>
                                    <option value="å„ªè³ªè—¥å“ä¾›æ‡‰å•†">å„ªè³ªè—¥å“ä¾›æ‡‰å•†</option>
                                    <option value="å°ˆæ¥­é†«æè¡Œ">å°ˆæ¥­é†«æè¡Œ</option>
                                </select>
                            </div>
                            <div class="form-col">
                                <label>è¯çµ¡äºº</label>
                                <input type="text" id="contactPerson">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-col">
                                <label>å‚™è¨»</label>
                                <textarea id="purchaseNote" placeholder="è«‹å¡«å¯«æ¡è³¼å‚™è¨»..."></textarea>
                            </div>
                        </div>
                       
                        <h3>æ¡è³¼å“é …</h3>
                        <button type="button" class="btn btn-primary" onclick="addPurchaseItem()">â• æ–°å¢å“é …</button>
                       
                        <table class="table items-table" id="purchaseItemsTable">
                            <thead>
                                <tr>
                                    <th>å“é …ç·¨è™Ÿ</th>
                                    <th>å“é …åç¨±</th>
                                    <th>è¦æ ¼</th>
                                    <th>æ•¸é‡</th>
                                    <th>å–®ä½</th>
                                    <th>å–®åƒ¹</th>
                                    <th>å°è¨ˆ</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="purchaseItemsTableBody">
                            </tbody>
                        </table>
                       
                        <div style="margin-top: 20px; text-align: right;">
                            <strong>ç¸½é‡‘é¡ï¼šNT$ <span id="purchaseTotalAmount">0</span></strong>
                        </div>
                       
                        <div style="margin-top: 30px;">
                            <button type="button" class="btn btn-success" onclick="submitPurchase()">ğŸ“¤ æäº¤æ¡è³¼å–®</button>
                            <button type="button" class="btn btn-secondary" onclick="resetPurchaseForm()">ğŸ”„ é‡è¨­</button>
                        </div>
                    </form>
                </div>

                <div id="inventory" class="page">
                    <h2>ğŸ“¦ åº«å­˜ç®¡ç†</h2>
                   
                    <div class="inventory-stats">
                        <div class="stat-card">
                            <h3 id="lowStockCount">0</h3>
                            <p>ä½åº«å­˜å“é …</p>
                        </div>
                        <div class="stat-card">
                            <h3 id="outOfStockCount">0</h3>
                            <p>ç¼ºè²¨å“é …</p>
                        </div>
                        <div class="stat-card">
                            <h3 id="totalItemsCount">0</h3>
                            <p>ç¸½å“é …æ•¸</p>
                        </div>
                    </div>

                    <div style="margin-bottom: 20px; display: flex; gap: 15px; flex-wrap: wrap;">
                        <div class="file-upload">
                            <input type="file" id="excelUpload" accept=".xlsx, .xls" onchange="handleExcelUpload(event)">
                            <label for="excelUpload" class="btn btn-primary">â¬†ï¸ ä¸Šå‚³åº«å­˜Excel</label>
                            <p id="uploadFileName" style="margin-top: 10px; color: #555;">æœªé¸æ“‡æª”æ¡ˆ</p>
                            <div id="uploadStatus" class="upload-status" style="display: none;"></div>
                        </div>
                        <button class="btn btn-success" onclick="downloadInventoryExcel()">â¬‡ï¸ ä¸‹è¼‰åº«å­˜Excel</button>
                        <button class="btn btn-secondary" onclick="openAddItemModal()">â• æ–°å¢å“é …</button>
                        <input type="text" id="inventorySearch" class="search-box" placeholder="æœå°‹å“é …åç¨±æˆ–ç·¨è™Ÿ..." onkeyup="filterInventory()">
                    </div>
                   
                    <table class="table" id="inventoryTable">
                        <thead>
                            <tr>
                                <th>å“é …ç·¨è™Ÿ</th>
                                <th>å“é …åç¨±</th>
                                <th>è¦æ ¼</th>
                                <th>å–®ä½</th>
                                <th>ç›®å‰åº«å­˜</th>
                                <th>å®‰å…¨åº«å­˜</th>
                                <th>ä¾›æ‡‰å•†</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="inventoryTableBody">
                            </tbody>
                    </table>
                </div>

                <div id="systemAdmin" class="page">
                    <h2>ğŸ› ï¸ ç³»çµ±ç®¡ç†</h2>
                   
                    <div class="section-divider">
                        <h3>ä½¿ç”¨è€…ç®¡ç†</h3>
                        <button class="btn btn-primary" onclick="openAddUserModal()">â• æ–°å¢ä½¿ç”¨è€…</button>
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>å¸³è™Ÿ</th>
                                    <th>å§“å</th>
                                    <th>è§’è‰²</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="userTableBody">
                                </tbody>
                        </table>
                    </div>

                    <div class="section-divider">
                        <h3>è§’è‰²èˆ‡æ¬Šé™è¨­å®š</h3>
                        <p>æ­¤åŠŸèƒ½ç‚ºé€²éšè¨­å®šï¼Œç›®å‰ç³»çµ±è§’è‰²å›ºå®šç‚º 'ç”³è«‹äºº' å’Œ 'ç®¡ç†å“¡'ã€‚</p>
                    </div>

                    <div class="section-divider">
                        <h3>ç³»çµ±æ—¥èªŒ</h3>
                        <p>æ­¤è™•å°‡é¡¯ç¤ºç³»çµ±æ“ä½œæ—¥èªŒã€‚</p>
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>æ™‚é–“</th>
                                    <th>ä½¿ç”¨è€…</th>
                                    <th>æ“ä½œ</th>
                                    <th>æè¿°</th>
                                </tr>
                            </thead>
                            <tbody id="logTableBody">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="procurementDetailModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('procurementDetailModal')">&times;</span>
            <h2>è«‹è³¼å–®è©³æƒ… - <span id="modalProcurementNo"></span></h2>
            <div class="form-row">
                <div class="form-col"><strong>ç”³è«‹æ—¥æœŸ:</strong> <span id="modalApplyDate"></span></div>
                <div class="form-col"><strong>ç”³è«‹éƒ¨é–€:</strong> <span id="modalDepartment"></span></div>
            </div>
            <div class="form-row">
                <div class="form-col"><strong>ç”³è«‹äºº:</strong> <span id="modalApplicantName"></span></div>
                <div class="form-col"><strong>è«‹è³¼äº‹ç”±:</strong> <span id="modalProcurementReason"></span></div>
            </div>
            <h3>è«‹è³¼å“é …</h3>
            <table class="table items-table">
                <thead>
                    <tr>
                        <th>é¡åˆ¥</th>
                        <th>åç¨±</th>
                        <th>è¦æ ¼</th>
                        <th>æ•¸é‡</th>
                        <th>å–®ä½</th>
                        <th>é ä¼°å–®åƒ¹</th>
                        <th>å°è¨ˆ</th>
                    </tr>
                </thead>
                <tbody id="modalItemsTableBody">
                </tbody>
            </table>
            <div style="margin-top: 20px; text-align: right;">
                <strong>ç¸½é‡‘é¡ï¼šNT$ <span id="modalTotalAmount">0</span></strong>
            </div>
            <div style="margin-top: 20px;" id="approvalActions">
                <button class="btn btn-success" onclick="approveProcurement()">âœ… æ ¸å‡†</button>
                <button class="btn btn-danger" onclick="openRejectModal('procurement')">ğŸš« é§å›</button>
            </div>
        </div>
    </div>

    <div id="purchaseDetailModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('purchaseDetailModal')">&times;</span>
            <h2>æ¡è³¼å–®è©³æƒ… - <span id="modalPurchaseNo"></span></h2>
            <div class="form-row">
                <div class="form-col"><strong>æ¡è³¼æ—¥æœŸ:</strong> <span id="modalPurchaseDate"></span></div>
                <div class="form-col"><strong>ä¾›æ‡‰å•†:</strong> <span id="modalSupplier"></span></div>
            </div>
            <div class="form-row">
                <div class="form-col"><strong>è¯çµ¡äºº:</strong> <span id="modalContactPerson"></span></div>
                <div class="form-col"><strong>å‚™è¨»:</strong> <span id="modalPurchaseNote"></span></div>
            </div>
            <h3>æ¡è³¼å“é …</h3>
            <table class="table items-table">
                <thead>
                    <tr>
                        <th>å“é …ç·¨è™Ÿ</th>
                        <th>å“é …åç¨±</th>
                        <th>è¦æ ¼</th>
                        <th>æ•¸é‡</th>
                        <th>å–®ä½</th>
                        <th>å–®åƒ¹</th>
                        <th>å°è¨ˆ</th>
                    </tr>
                </thead>
                <tbody id="modalPurchaseItemsTableBody">
                </tbody>
            </table>
            <div style="margin-top: 20px; text-align: right;">
                <strong>ç¸½é‡‘é¡ï¼šNT$ <span id="modalPurchaseTotalAmount">0</span></strong>
            </div>
            <div style="margin-top: 20px;" id="purchaseApprovalActions">
                <button class="btn btn-success" onclick="approvePurchase()">âœ… æ ¸å‡†æ¡è³¼å–®</button>
                <button class="btn btn-danger" onclick="openRejectModal('purchase')">ğŸš« é§å›æ¡è³¼å–®</button>
            </div>
        </div>
    </div>

    <div id="rejectModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('rejectModal')">&times;</span>
            <h2>é§å›åŸå› </h2>
            <div class="form-group">
                <label for="rejectReason">è«‹è¼¸å…¥é§å›åŸå› :</label>
                <textarea id="rejectReason" rows="4"></textarea>
            </div>
            <button class="btn btn-danger" onclick="confirmReject()">ç¢ºèªé§å›</button>
        </div>
    </div>

    <div id="addInventoryItemModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('addInventoryItemModal')">&times;</span>
            <h2>æ–°å¢åº«å­˜å“é …</h2>
            <div class="form-group">
                <label for="newItemId">å“é …ç·¨è™Ÿ:</label>
                <input type="text" id="newItemId">
            </div>
            <div class="form-group">
                <label for="newItemName">å“é …åç¨±:</label>
                <input type="text" id="newItemName">
            </div>
            <div class="form-group">
                <label for="newItemSpec">è¦æ ¼:</label>
                <input type="text" id="newItemSpec">
            </div>
            <div class="form-group">
                <label for="newItemUnit">å–®ä½:</label>
                <input type="text" id="newItemUnit">
            </div>
            <div class="form-group">
                <label for="newItemCurrentStock">ç›®å‰åº«å­˜:</label>
                <input type="number" id="newItemCurrentStock" min="0" value="0">
            </div>
            <div class="form-group">
                <label for="newItemSafetyStock">å®‰å…¨åº«å­˜:</label>
                <input type="number" id="newItemSafetyStock" min="0" value="0">
            </div>
            <div class="form-group">
                <label for="newItemSupplier">ä¾›æ‡‰å•†:</label>
                <input type="text" id="newItemSupplier">
            </div>
            <button class="btn btn-success" onclick="addNewInventoryItem()">æ–°å¢å“é …</button>
        </div>
    </div>

    <div id="editInventoryItemModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('editInventoryItemModal')">&times;</span>
            <h2>ç·¨è¼¯åº«å­˜å“é …</h2>
            <input type="hidden" id="editItemOriginalId">
            <div class="form-group">
                <label for="editItemId">å“é …ç·¨è™Ÿ:</label>
                <input type="text" id="editItemId">
            </div>
            <div class="form-group">
                <label for="editItemName">å“é …åç¨±:</label>
                <input type="text" id="editItemName">
            </div>
            <div class="form-group">
                <label for="editItemSpec">è¦æ ¼:</label>
                <input type="text" id="editItemSpec">
            </div>
            <div class="form-group">
                <label for="editItemUnit">å–®ä½:</label>
                <input type="text" id="editItemUnit">
            </div>
            <div class="form-group">
                <label for="editItemCurrentStock">ç›®å‰åº«å­˜:</label>
                <input type="number" id="editItemCurrentStock" min="0">
            </div>
            <div class="form-group">
                <label for="editItemSafetyStock">å®‰å…¨åº«å­˜:</label>
                <input type="number" id="editItemSafetyStock" min="0">
            </div>
            <div class="form-group">
                <label for="editItemSupplier">ä¾›æ‡‰å•†:</label>
                <input type="text" id="editItemSupplier">
            </div>
            <button class="btn btn-success" onclick="updateInventoryItem()">å„²å­˜è®Šæ›´</button>
        </div>
    </div>

    <div id="addUserModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('addUserModal')">&times;</span>
            <h2>æ–°å¢ä½¿ç”¨è€…</h2>
            <div class="form-group">
                <label for="newUsername">å¸³è™Ÿ:</label>
                <input type="text" id="newUsername">
            </div>
            <div class="form-group">
                <label for="newPassword">å¯†ç¢¼:</label>
                <input type="password" id="newPassword">
            </div>
            <div class="form-group">
                <label for="newFullName">å§“å:</label>
                <input type="text" id="newFullName">
            </div>
            <div class="form-group">
                <label for="newUserRole">è§’è‰²:</label>
                <select id="newUserRole">
                    <option value="applicant">ç”³è«‹äºº</option>
                    <option value="admin">ç®¡ç†å“¡</option>
                </select>
            </div>
            <button class="btn btn-success" onclick="addNewUser()">æ–°å¢ä½¿ç”¨è€…</button>
        </div>
    </div>

    <div id="editUserModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('editUserModal')">&times;</span>
            <h2>ç·¨è¼¯ä½¿ç”¨è€…</h2>
            <input type="hidden" id="editUserOriginalUsername">
            <div class="form-group">
                <label for="editUsername">å¸³è™Ÿ:</label>
                <input type="text" id="editUsername" readonly>
            </div>
            <div class="form-group">
                <label for="editPassword">æ–°å¯†ç¢¼ (ç•™ç©ºå‰‡ä¸æ›´æ”¹):</label>
                <input type="password" id="editPassword">
            </div>
            <div class="form-group">
                <label for="editFullName">å§“å:</label>
                <input type="text" id="editFullName">
            </div>
            <div class="form-group">
                <label for="editUserRole">è§’è‰²:</label>
                <select id="editUserRole">
                    <option value="applicant">ç”³è«‹äºº</option>
                    <option value="admin">ç®¡ç†å“¡</option>
                </select>
            </div>
            <button class="btn btn-success" onclick="updateUser()">å„²å­˜è®Šæ›´</button>
        </div>
    </div>

    <div id="previewSelectedItemsModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('previewSelectedItemsModal')">&times;</span>
            <h2>é è¦½é¸å–çš„è«‹è³¼é …ç›®</h2>
            <table class="table items-table">
                <thead>
                    <tr>
                        <th>è«‹è³¼å–®è™Ÿ</th>
                        <th>å“é …åç¨±</th>
                        <th>è¦æ ¼</th>
                        <th>æ•¸é‡</th>
                        <th>å–®ä½</th>
                        <th>é ä¼°å–®åƒ¹</th>
                        <th>å°è¨ˆ</th>
                    </tr>
                </thead>
                <tbody id="previewSelectedItemsTableBody">
                </tbody>
            </table>
            <div style="margin-top: 20px; text-align: right;">
                <strong>ç¸½è¨ˆé‡‘é¡ï¼šNT$ <span id="previewTotalAmount">0</span></strong>
            </div>
            <div style="margin-top: 20px;">
                <button class="btn btn-success" onclick="confirmCreatePurchaseFromPreview()">ç¢ºèªä¸¦å»ºç«‹æ¡è³¼å–®</button>
            </div>
        </div>
    </div>

    <script>
        // æ‚¨çš„JavaScriptä»£ç¢¼å°‡æ”¾åœ¨é€™è£¡
        // ç¢ºä¿æ‰€æœ‰åŠŸèƒ½ï¼ˆç™»å…¥ã€é é¢åˆ‡æ›ã€æ•¸æ“šæ“ä½œã€Excelå°å‡ºå°å…¥ç­‰ï¼‰éƒ½åœ¨æ­¤è…³æœ¬ä¸­
        // å› ç‚ºæ˜¯ç´”å‰ç«¯æ‡‰ç”¨ï¼Œæ•¸æ“šå°‡ä½¿ç”¨ localStorage é€²è¡Œæ¨¡æ“¬å­˜å„²

        // æ¨¡æ“¬æ•¸æ“šåº« (ä½¿ç”¨ localStorage å­˜å„²)
        let users = JSON.parse(localStorage.getItem('users')) || [
            { username: 'admin', password: 'admin', fullname: 'ç³»çµ±ç®¡ç†å“¡', role: 'admin' },
            { username: 'user1', password: 'user1', fullname: 'å…§ç§‘é†«å¸«', role: 'applicant' },
            { username: 'user2', password: 'user2', fullname: 'è—¥åŠ‘å¸«', role: 'applicant' }
        ];

        let procurements = JSON.parse(localStorage.getItem('procurements')) || [];
        let purchases = JSON.parse(localStorage.getItem('purchases')) || [];
        let inventory = JSON.parse(localStorage.getItem('inventory')) || [
            { id: 'D001', name: 'æ­¢ç—›è—¥', spec: '500mg/éŒ ', unit: 'éŒ ', currentStock: 1000, safetyStock: 200, supplier: 'å„ªè³ªè—¥å“ä¾›æ‡‰å•†' },
            { id: 'M001', name: 'N95å£ç½©', spec: 'æˆäººç”¨', unit: 'å€‹', currentStock: 500, safetyStock: 100, supplier: 'å°ç£é†«æå…¬å¸' },
            { id: 'D002', name: 'æŠ—ç”Ÿç´ ', spec: 'æ³¨å°„åŠ‘', unit: 'åŠ‘', currentStock: 300, safetyStock: 50, supplier: 'å„ªè³ªè—¥å“ä¾›æ‡‰å•†' },
            { id: 'M002', name: 'é»æ»´æ¶', spec: 'ä¸é½é‹¼', unit: 'çµ„', currentStock: 50, safetyStock: 10, supplier: 'åº·å¥é†«ç™‚å™¨æ' }
        ];
        let logs = JSON.parse(localStorage.getItem('logs')) || [];

        let currentUser = null;
        let selectedProcurementIdForReject = null; // ç”¨æ–¼é§å›åŠŸèƒ½
        let selectedPurchaseIdForReject = null; // ç”¨æ–¼é§å›åŠŸèƒ½

        // ä¿å­˜æ•¸æ“šåˆ° localStorage
        function saveData() {
            localStorage.setItem('users', JSON.stringify(users));
            localStorage.setItem('procurements', JSON.stringify(procurements));
            localStorage.setItem('purchases', JSON.stringify(purchases));
            localStorage.setItem('inventory', JSON.stringify(inventory));
            localStorage.setItem('logs', JSON.stringify(logs));
        }

        // è¨˜éŒ„æ“ä½œæ—¥èªŒ
        function addLog(action, description) {
            const now = new Date();
            const log = {
                timestamp: now.toLocaleString('zh-TW', { hour12: false }),
                user: currentUser ? currentUser.fullname : 'è¨ªå®¢',
                action: action,
                description: description
            };
            logs.unshift(log); // æœ€æ–°æ—¥èªŒæ”¾åœ¨æœ€å‰é¢
            saveData();
            renderLogs();
        }

        // ç™»å…¥åŠŸèƒ½
        function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            const user = users.find(u => u.username === username && u.password === password);

            if (user) {
                currentUser = user;
                document.getElementById('currentUser').textContent = currentUser.fullname;
                document.getElementById('loginPage').style.display = 'none';
                document.getElementById('mainSystem').style.display = 'block';
                updateNavigationVisibility(); // æ ¹æ“šè§’è‰²æ›´æ–°å°èˆªèœå–®å¯è¦‹æ€§
                showPage('newProcurement'); // é è¨­é¡¯ç¤ºæ–°å¢è«‹è³¼é é¢
                addLog('ç™»å…¥', `ä½¿ç”¨è€… ${currentUser.fullname} ç™»å…¥ç³»çµ±ã€‚`);
            } else {
                alert('å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤ï¼');
            }
        }

        // ç™»å‡ºåŠŸèƒ½
        function logout() {
            addLog('ç™»å‡º', `ä½¿ç”¨è€… ${currentUser.fullname} ç™»å‡ºç³»çµ±ã€‚`);
            currentUser = null;
            document.getElementById('loginPage').style.display = 'flex';
            document.getElementById('mainSystem').style.display = 'none';
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            resetForm(); // é‡ç½®è«‹è³¼è¡¨å–®
            resetPurchaseForm(); // é‡ç½®æ¡è³¼è¡¨å–®
        }

        // æ ¹æ“šä½¿ç”¨è€…è§’è‰²æ›´æ–°å°èˆªèœå–®å¯è¦‹æ€§
        function updateNavigationVisibility() {
            const approvalBtn = document.getElementById('approvalBtn');
            const createPurchaseBtn = document.querySelector('.nav-btn[onclick="showPage(\'createPurchase\')"]');
            const inventoryBtn = document.querySelector('.nav-btn[onclick="showPage(\'inventory\')"]');
            const systemAdminBtn = document.querySelector('.nav-btn[onclick="showPage(\'systemAdmin\')"]');

            if (currentUser && currentUser.role === 'admin') {
                approvalBtn.style.display = 'flex'; // ç®¡ç†å“¡é¡¯ç¤ºç°½æ ¸ç®¡ç†
                createPurchaseBtn.style.display = 'flex'; // ç®¡ç†å“¡é¡¯ç¤ºå»ºç«‹æ¡è³¼å–®
                inventoryBtn.style.display = 'flex'; // ç®¡ç†å“¡é¡¯ç¤ºåº«å­˜ç®¡ç†
                systemAdminBtn.style.display = 'flex'; // ç®¡ç†å“¡é¡¯ç¤ºç³»çµ±ç®¡ç†
            } else {
                approvalBtn.style.display = 'none'; // ç”³è«‹äººéš±è—ç°½æ ¸ç®¡ç†
                createPurchaseBtn.style.display = 'none'; // ç”³è«‹äººéš±è—å»ºç«‹æ¡è³¼å–®
                inventoryBtn.style.display = 'none'; // ç”³è«‹äººéš±è—åº«å­˜ç®¡ç†
                systemAdminBtn.style.display = 'none'; // ç”³è«‹äººéš±è—ç³»çµ±ç®¡ç†
            }
            updatePendingCount(); // æ›´æ–°å¾…ç°½æ ¸æ•¸é‡
        }

        // é é¢åˆ‡æ›
        function showPage(pageId) {
            const pages = document.querySelectorAll('.page');
            pages.forEach(page => page.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');

            const navBtns = document.querySelectorAll('.nav-btn');
            navBtns.forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.nav-btn[onclick="showPage('${pageId}')"]`).classList.add('active');

            // æ ¹æ“šä¸åŒé é¢è¼‰å…¥æ•¸æ“š
            if (pageId === 'approvalManagement') {
                showApprovalType('procurement'); // é è¨­é¡¯ç¤ºè«‹è³¼å–®ç°½æ ¸
            } else if (pageId === 'approved') {
                showApprovedType('procurement'); // é è¨­é¡¯ç¤ºå·²æ ¸å‡†è«‹è³¼å–®
                updateSelectedCount(); // æ›´æ–°å·²æ ¸å‡†é é¢çš„é¸ä¸­é …ç›®è¨ˆæ•¸
            } else if (pageId === 'rejected') {
                showRejectedType('procurement'); // é è¨­é¡¯ç¤ºå·²é§å›è«‹è³¼å–®
            } else if (pageId === 'inventory') {
                renderInventory();
                updateInventoryStats();
            } else if (pageId === 'systemAdmin') {
                renderUsers();
                renderLogs();
            } else if (pageId === 'newProcurement') {
                generateProcurementNo();
                document.getElementById('applyDate').valueAsDate = new Date();
                resetForm(); // ç¢ºä¿æ¯æ¬¡é€²å…¥éƒ½æ˜¯æ¸…ç©ºçš„è¡¨å–®
            } else if (pageId === 'createPurchase') {
                generatePurchaseNo();
                document.getElementById('purchaseDate').valueAsDate = new Date();
                resetPurchaseForm(); // ç¢ºä¿æ¯æ¬¡é€²å…¥éƒ½æ˜¯æ¸…ç©ºçš„è¡¨å–®
            }
            // é—œé–‰æ‰€æœ‰ä¸‹æ‹‰é¸å–®
            document.querySelectorAll('.dropdown-content.show').forEach(dropdown => {
                dropdown.classList.remove('show');
            });
        }

        // ç”Ÿæˆè«‹è³¼å–®è™Ÿ
        function generateProcurementNo() {
            const today = new Date();
            const year = today.getFullYear();
            const month = (today.getMonth() + 1).toString().padStart(2, '0');
            const day = today.getDate().toString().padStart(2, '0');

            // å¾ localStorage ç²å–ç•¶å¤©çš„æœ€å¤§åºè™Ÿ
            const todayProcurements = procurements.filter(p => p.procurementNo.startsWith(`REQ-${year}${month}${day}`));
            let maxSerial = 0;
            if (todayProcurements.length > 0) {
                const serials = todayProcurements.map(p => parseInt(p.procurementNo.slice(-3)));
                maxSerial = Math.max(...serials);
            }
            const nextSerial = (maxSerial + 1).toString().padStart(3, '0');
            document.getElementById('procurementNo').value = `REQ-${year}${month}${day}-${nextSerial}`;
        }

        // ç”Ÿæˆæ¡è³¼å–®è™Ÿ
        function generatePurchaseNo() {
            const today = new Date();
            const year = today.getFullYear();
            const month = (today.getMonth() + 1).toString().padStart(2, '0');
            const day = today.getDate().toString().padStart(2, '0');

            const todayPurchases = purchases.filter(p => p.purchaseNo.startsWith(`PO-${year}${month}${day}`));
            let maxSerial = 0;
            if (todayPurchases.length > 0) {
                const serials = todayPurchases.map(p => parseInt(p.purchaseNo.slice(-3)));
                maxSerial = Math.max(...serials);
            }
            const nextSerial = (maxSerial + 1).toString().padStart(3, '0');
            document.getElementById('purchaseNo').value = `PO-${year}${month}${day}-${nextSerial}`;
        }


        // è«‹è³¼å–®é …ç›®ç®¡ç†
        function addItem() {
            const tableBody = document.getElementById('itemsTableBody');
            const newRow = tableBody.insertRow();
            newRow.innerHTML = `
                <td><input type="text" placeholder="é¡åˆ¥"></td>
                <td><input type="text" placeholder="åç¨±"></td>
                <td><input type="text" placeholder="è¦æ ¼"></td>
                <td><input type="number" min="1" value="1" onchange="calculateSubtotal(this.parentNode.parentNode)"></td>
                <td><input type="text" placeholder="å–®ä½"></td>
                <td><input type="number" min="0" step="0.01" value="0" onchange="calculateSubtotal(this.parentNode.parentNode)"></td>
                <td class="subtotal">0</td>
                <td><button type="button" class="btn btn-danger btn-sm" onclick="deleteItem(this)">åˆªé™¤</button></td>
            `;
            calculateTotalAmount();
        }

        function deleteItem(button) {
            button.parentNode.parentNode.remove();
            calculateTotalAmount();
        }

        function calculateSubtotal(row) {
            const quantity = parseFloat(row.cells[3].querySelector('input').value) || 0;
            const unitPrice = parseFloat(row.cells[5].querySelector('input').value) || 0;
            const subtotal = quantity * unitPrice;
            row.cells[6].textContent = subtotal.toFixed(2);
            calculateTotalAmount();
        }

        function calculateTotalAmount() {
            let total = 0;
            const tableBody = document.getElementById('itemsTableBody');
            for (let i = 0; i < tableBody.rows.length; i++) {
                total += parseFloat(tableBody.rows[i].cells[6].textContent) || 0;
            }
            document.getElementById('totalAmount').textContent = total.toFixed(2);
        }

        // æäº¤è«‹è³¼å–®
        function submitProcurement() {
            const procurementNo = document.getElementById('procurementNo').value;
            const applyDate = document.getElementById('applyDate').value;
            const department = document.getElementById('department').value;
            const applicantName = document.getElementById('applicantName').value;
            const procurementReason = document.getElementById('procurementReason').value;

            if (!procurementNo || !applyDate || !department || !applicantName || !procurementReason) {
                alert('è«‹å¡«å¯«æ‰€æœ‰è«‹è³¼å–®åŸºæœ¬è³‡è¨Šï¼');
                return;
            }

            const items = [];
            const tableBody = document.getElementById('itemsTableBody');
            if (tableBody.rows.length === 0) {
                alert('è«‹è‡³å°‘æ–°å¢ä¸€å€‹è«‹è³¼å“é …ï¼');
                return;
            }

            for (let i = 0; i < tableBody.rows.length; i++) {
                const row = tableBody.rows[i];
                const item = {
                    category: row.cells[0].querySelector('input').value,
                    name: row.cells[1].querySelector('input').value,
                    spec: row.cells[2].querySelector('input').value,
                    quantity: parseFloat(row.cells[3].querySelector('input').value),
                    unit: row.cells[4].querySelector('input').value,
                    estimatedUnitPrice: parseFloat(row.cells[5].querySelector('input').value),
                    subtotal: parseFloat(row.cells[6].textContent)
                };
                if (!item.category || !item.name || !item.spec || item.quantity <= 0 || !item.unit || item.estimatedUnitPrice < 0) {
                    alert('è«‹æª¢æŸ¥æ‰€æœ‰è«‹è³¼å“é …çš„è³‡è¨Šæ˜¯å¦å¡«å¯«å®Œæ•´ä¸”æ­£ç¢ºï¼');
                    return;
                }
                items.push(item);
            }

            const totalAmount = parseFloat(document.getElementById('totalAmount').textContent);

            const newProcurement = {
                id: procurements.length + 1, // ç°¡å–®çš„IDç”Ÿæˆ
                procurementNo: procurementNo,
                applyDate: applyDate,
                department: department,
                applicantName: applicantName,
                procurementReason: procurementReason,
                items: items,
                totalAmount: totalAmount,
                status: 'pending', // åˆå§‹ç‹€æ…‹ç‚ºå¾…ç°½æ ¸
                approver: null,
                approvalTime: null,
                rejectReason: null
            };

            procurements.unshift(newProcurement); // æ–°çš„è«‹è³¼å–®æ”¾åœ¨æœ€å‰é¢
            saveData();
            alert('è«‹è³¼å–®æäº¤æˆåŠŸï¼Œç­‰å¾…ç°½æ ¸ï¼');
            addLog('æäº¤è«‹è³¼å–®', `æäº¤è«‹è³¼å–®è™Ÿ: ${procurementNo}`);
            resetForm();
            updatePendingCount();
        }

        // é‡ç½®è«‹è³¼è¡¨å–®
        function resetForm() {
            document.getElementById('procurementForm').reset();
            document.getElementById('itemsTableBody').innerHTML = '';
            document.getElementById('totalAmount').textContent = '0';
            generateProcurementNo();
            document.getElementById('applyDate').valueAsDate = new Date();
        }

        // æ›´æ–°å¾…ç°½æ ¸æ•¸é‡
        function updatePendingCount() {
            const pendingProcurements = procurements.filter(p => p.status === 'pending');
            const pendingPurchases = purchases.filter(p => p.status === 'pending');
            const count = pendingProcurements.length + pendingPurchases.length;
            const badge = document.getElementById('pendingCount');
            if (count > 0 && currentUser && currentUser.role === 'admin') {
                badge.textContent = count;
                badge.style.display = 'flex';
            } else {
                badge.style.display = 'none';
            }
        }

        // é¡¯ç¤ºç°½æ ¸é¡å‹
        function showApprovalType(type) {
            document.getElementById('procurementApproval').style.display = 'none';
            document.getElementById('purchaseApproval').style.display = 'none';
            if (type === 'procurement') {
                document.getElementById('procurementApproval').style.display = 'block';
                renderPendingProcurements();
            } else if (type === 'purchase') {
                document.getElementById('purchaseApproval').style.display = 'block';
                renderPendingPurchases();
            }
        }

        // æ¸²æŸ“å¾…ç°½æ ¸è«‹è³¼å–®
        function renderPendingProcurements() {
            const tableBody = document.getElementById('pendingProcurementTable');
            tableBody.innerHTML = '';
            const pending = procurements.filter(p => p.status === 'pending');
            if (pending.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">ç›®å‰æ²’æœ‰å¾…å¯©æ ¸çš„è«‹è³¼å–®ã€‚</td></tr>';
                return;
            }

            pending.forEach(p => {
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td>${p.procurementNo}</td>
                    <td>${p.applyDate}</td>
                    <td>${p.department}</td>
                    <td>${p.applicantName}</td>
                    <td><span class="status-badge status-pending">å¾…ç°½æ ¸</span></td>
                    <td>
                        <button class="btn btn-primary" onclick="viewProcurementDetail('${p.procurementNo}')">æŸ¥çœ‹è©³æƒ…</button>
                    </td>
                `;
            });
        }

        // æ¸²æŸ“å¾…ç°½æ ¸æ¡è³¼å–®
        function renderPendingPurchases() {
            const tableBody = document.getElementById('pendingPurchaseTable');
            tableBody.innerHTML = '';
            const pending = purchases.filter(p => p.status === 'pending');
            if (pending.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">ç›®å‰æ²’æœ‰å¾…å¯©æ ¸çš„æ¡è³¼å–®ã€‚</td></tr>';
                return;
            }

            pending.forEach(p => {
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td>${p.purchaseNo}</td>
                    <td>${p.purchaseDate}</td>
                    <td>${p.supplier}</td>
                    <td>NT$ ${p.totalAmount.toFixed(2)}</td>
                    <td><span class="status-badge status-pending">å¾…ç°½æ ¸</span></td>
                    <td>
                        <button class="btn btn-primary" onclick="viewPurchaseDetail('${p.purchaseNo}')">æŸ¥çœ‹è©³æƒ…</button>
                    </td>
                `;
            });
        }

        // æŸ¥çœ‹è«‹è³¼å–®è©³æƒ…
        function viewProcurementDetail(procurementNo) {
            const procurement = procurements.find(p => p.procurementNo === procurementNo);
            if (!procurement) return;

            document.getElementById('modalProcurementNo').textContent = procurement.procurementNo;
            document.getElementById('modalApplyDate').textContent = procurement.applyDate;
            document.getElementById('modalDepartment').textContent = procurement.department;
            document.getElementById('modalApplicantName').textContent = procurement.applicantName;
            document.getElementById('modalProcurementReason').textContent = procurement.procurementReason;

            const itemsBody = document.getElementById('modalItemsTableBody');
            itemsBody.innerHTML = '';
            procurement.items.forEach(item => {
                const row = itemsBody.insertRow();
                row.innerHTML = `
                    <td>${item.category}</td>
                    <td>${item.name}</td>
                    <td>${item.spec}</td>
                    <td>${item.quantity}</td>
                    <td>${item.unit}</td>
                    <td>${item.estimatedUnitPrice.toFixed(2)}</td>
                    <td>${item.subtotal.toFixed(2)}</td>
                `;
            });
            document.getElementById('modalTotalAmount').textContent = procurement.totalAmount.toFixed(2);

            // å¦‚æœæ˜¯ç®¡ç†å“¡ä¸”è«‹è³¼å–®å¾…ç°½æ ¸ï¼Œé¡¯ç¤ºç°½æ ¸æŒ‰éˆ•
            const approvalActions = document.getElementById('approvalActions');
            if (currentUser && currentUser.role === 'admin' && procurement.status === 'pending') {
                approvalActions.style.display = 'block';
            } else {
                approvalActions.style.display = 'none';
            }

            selectedProcurementIdForReject = procurementNo; // ä¿å­˜ç•¶å‰æŸ¥çœ‹çš„è«‹è³¼å–®è™Ÿï¼Œç”¨æ–¼é§å›
            document.getElementById('procurementDetailModal').style.display = 'block';
        }

        // æŸ¥çœ‹æ¡è³¼å–®è©³æƒ…
        function viewPurchaseDetail(purchaseNo) {
            const purchase = purchases.find(p => p.purchaseNo === purchaseNo);
            if (!purchase) return;

            document.getElementById('modalPurchaseNo').textContent = purchase.purchaseNo;
            document.getElementById('modalPurchaseDate').textContent = purchase.purchaseDate;
            document.getElementById('modalSupplier').textContent = purchase.supplier;
            document.getElementById('modalContactPerson').textContent = purchase.contactPerson;
            document.getElementById('modalPurchaseNote').textContent = purchase.purchaseNote;

            const itemsBody = document.getElementById('modalPurchaseItemsTableBody');
            itemsBody.innerHTML = '';
            purchase.items.forEach(item => {
                const row = itemsBody.insertRow();
                row.innerHTML = `
                    <td>${item.id || ''}</td>
                    <td>${item.name}</td>
                    <td>${item.spec}</td>
                    <td>${item.quantity}</td>
                    <td>${item.unit}</td>
                    <td>${item.unitPrice.toFixed(2)}</td>
                    <td>${item.subtotal.toFixed(2)}</td>
                `;
            });
            document.getElementById('modalPurchaseTotalAmount').textContent = purchase.totalAmount.toFixed(2);

            // å¦‚æœæ˜¯ç®¡ç†å“¡ä¸”æ¡è³¼å–®å¾…ç°½æ ¸ï¼Œé¡¯ç¤ºç°½æ ¸æŒ‰éˆ•
            const purchaseApprovalActions = document.getElementById('purchaseApprovalActions');
            if (currentUser && currentUser.role === 'admin' && purchase.status === 'pending') {
                purchaseApprovalActions.style.display = 'block';
            } else {
                purchaseApprovalActions.style.display = 'none';
            }

            selectedPurchaseIdForReject = purchaseNo; // ä¿å­˜ç•¶å‰æŸ¥çœ‹çš„æ¡è³¼å–®è™Ÿï¼Œç”¨æ–¼é§å›
            document.getElementById('purchaseDetailModal').style.display = 'block';
        }


        // æ ¸å‡†è«‹è³¼å–®
        function approveProcurement() {
            const procurementNo = document.getElementById('modalProcurementNo').textContent;
            const procurementIndex = procurements.findIndex(p => p.procurementNo === procurementNo);

            if (procurementIndex !== -1) {
                procurements[procurementIndex].status = 'approved';
                procurements[procurementIndex].approver = currentUser.fullname;
                procurements[procurementIndex].approvalTime = new Date().toLocaleString('zh-TW', { hour12: false });
                saveData();
                alert(`è«‹è³¼å–® ${procurementNo} å·²æ ¸å‡†ï¼`);
                addLog('æ ¸å‡†è«‹è³¼å–®', `æ ¸å‡†è«‹è³¼å–®è™Ÿ: ${procurementNo}`);
                closeModal('procurementDetailModal');
                renderPendingProcurements(); // åˆ·æ–°å¾…ç°½æ ¸åˆ—è¡¨
                updatePendingCount();
                showApprovedType('procurement'); // åˆ·æ–°å·²æ ¸å‡†åˆ—è¡¨
            }
        }

        // æ ¸å‡†æ¡è³¼å–®
        function approvePurchase() {
            const purchaseNo = document.getElementById('modalPurchaseNo').textContent;
            const purchaseIndex = purchases.findIndex(p => p.purchaseNo === purchaseNo);

            if (purchaseIndex !== -1) {
                purchases[purchaseIndex].status = 'approved';
                purchases[purchaseIndex].approver = currentUser.fullname;
                purchases[purchaseIndex].approvalTime = new Date().toLocaleString('zh-TW', { hour12: false });
                saveData();
                alert(`æ¡è³¼å–® ${purchaseNo} å·²æ ¸å‡†ï¼`);
                addLog('æ ¸å‡†æ¡è³¼å–®', `æ ¸å‡†æ¡è³¼å–®è™Ÿ: ${purchaseNo}`);
                closeModal('purchaseDetailModal');
                renderPendingPurchases(); // åˆ·æ–°å¾…ç°½æ ¸åˆ—è¡¨
                updatePendingCount();
                showApprovedType('purchase'); // åˆ·æ–°å·²æ ¸å‡†åˆ—è¡¨
            }
        }

        // é–‹å•Ÿé§å›æ¨¡æ…‹æ¡†
        function openRejectModal(type) {
            document.getElementById('rejectReason').value = ''; // æ¸…ç©ºåŸå› 
            document.getElementById('rejectModal').dataset.type = type; // å„²å­˜é§å›é¡å‹
            closeModal('procurementDetailModal'); // é—œé–‰è«‹è³¼å–®è©³æƒ…
            closeModal('purchaseDetailModal'); // é—œé–‰æ¡è³¼å–®è©³æƒ…
            document.getElementById('rejectModal').style.display = 'block';
        }

        // ç¢ºèªé§å›
        function confirmReject() {
            const rejectReason = document.getElementById('rejectReason').value;
            const rejectType = document.getElementById('rejectModal').dataset.type;
            const now = new Date().toLocaleString('zh-TW', { hour12: false });

            if (!rejectReason) {
                alert('è«‹è¼¸å…¥é§å›åŸå› ï¼');
                return;
            }

            if (rejectType === 'procurement') {
                const procurementIndex = procurements.findIndex(p => p.procurementNo === selectedProcurementIdForReject);
                if (procurementIndex !== -1) {
                    procurements[procurementIndex].status = 'rejected';
                    procurements[procurementIndex].approver = currentUser.fullname; // è¨˜éŒ„é§å›äºº
                    procurements[procurementIndex].approvalTime = now; // è¨˜éŒ„é§å›æ™‚é–“
                    procurements[procurementIndex].rejectReason = rejectReason;
                    saveData();
                    alert(`è«‹è³¼å–® ${selectedProcurementIdForReject} å·²é§å›ï¼`);
                    addLog('é§å›è«‹è³¼å–®', `é§å›è«‹è³¼å–®è™Ÿ: ${selectedProcurementIdForReject}ï¼ŒåŸå› : ${rejectReason}`);
                    renderPendingProcurements(); // åˆ·æ–°å¾…ç°½æ ¸åˆ—è¡¨
                    updatePendingCount();
                    showRejectedType('procurement'); // åˆ·æ–°å·²é§å›åˆ—è¡¨
                }
            } else if (rejectType === 'purchase') {
                const purchaseIndex = purchases.findIndex(p => p.purchaseNo === selectedPurchaseIdForReject);
                if (purchaseIndex !== -1) {
                    purchases[purchaseIndex].status = 'rejected';
                    purchases[purchaseIndex].approver = currentUser.fullname; // è¨˜éŒ„é§å›äºº
                    purchases[purchaseIndex].approvalTime = now; // è¨˜éŒ„é§å›æ™‚é–“
                    purchases[purchaseIndex].rejectReason = rejectReason;
                    saveData();
                    alert(`æ¡è³¼å–® ${selectedPurchaseIdForReject} å·²é§å›ï¼`);
                    addLog('é§å›æ¡è³¼å–®', `é§å›æ¡è³¼å–®è™Ÿ: ${selectedPurchaseIdForReject}ï¼ŒåŸå› : ${rejectReason}`);
                    renderPendingPurchases(); // åˆ·æ–°å¾…ç°½æ ¸åˆ—è¡¨
                    updatePendingCount();
                    showRejectedType('purchase'); // åˆ·æ–°å·²é§å›åˆ—è¡¨
                }
            }
            closeModal('rejectModal');
        }

        // é—œé–‰æ¨¡æ…‹æ¡†
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // é¡¯ç¤ºå·²æ ¸å‡†é¡å‹
        function showApprovedType(type) {
            document.getElementById('approvedProcurementSection').style.display = 'none';
            document.getElementById('approvedPurchaseSection').style.display = 'none';
            if (type === 'procurement') {
                document.getElementById('approvedProcurementSection').style.display = 'block';
                renderApprovedProcurements();
            } else if (type === 'purchase') {
                document.getElementById('approvedPurchaseSection').style.display = 'block';
                renderApprovedPurchases();
            }
            // é‡ç½®å…¨é¸ç‹€æ…‹å’Œè¨ˆæ•¸
            document.getElementById('selectAllCheckbox').checked = false;
            updateSelectedCount();
        }

        // æ¸²æŸ“å·²æ ¸å‡†è«‹è³¼å–®
        function renderApprovedProcurements() {
            const tableBody = document.getElementById('approvedProcurementTable');
            tableBody.innerHTML = '';
            const approved = procurements.filter(p => p.status === 'approved');
            if (approved.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="9" style="text-align: center;">ç›®å‰æ²’æœ‰å·²æ ¸å‡†çš„è«‹è³¼å–®ã€‚</td></tr>';
                return;
            }

            approved.forEach(p => {
                const row = tableBody.insertRow();
                row.dataset.procurementNo = p.procurementNo; // ç”¨æ–¼å¾ŒçºŒé¸æ“‡
                row.innerHTML = `
                    <td><input type="checkbox" class="approved-checkbox" onchange="updateSelectedCount()"></td>
                    <td>${p.procurementNo}</td>
                    <td>${p.applyDate}</td>
                    <td>${p.department}</td>
                    <td>${p.applicantName}</td>
                    <td>NT$ ${p.totalAmount.toFixed(2)}</td>
                    <td>${p.approver || 'N/A'}</td>
                    <td>${p.approvalTime || 'N/A'}</td>
                    <td>
                        <button class="btn btn-primary" onclick="viewProcurementDetail('${p.procurementNo}')">æŸ¥çœ‹è©³æƒ…</button>
                        <button class="btn btn-success" onclick="downloadProcurementExcel('${p.procurementNo}')">ä¸‹è¼‰Excel</button>
                    </td>
                `;
            });
        }

        // æ¸²æŸ“å·²æ ¸å‡†æ¡è³¼å–®
        function renderApprovedPurchases() {
            const tableBody = document.getElementById('approvedPurchaseTable');
            tableBody.innerHTML = '';
            const approved = purchases.filter(p => p.status === 'approved');
            if (approved.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="8" style="text-align: center;">ç›®å‰æ²’æœ‰å·²æ ¸å‡†çš„æ¡è³¼å–®ã€‚</td></tr>';
                return;
            }

            approved.forEach(p => {
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td>${p.purchaseNo}</td>
                    <td>${p.purchaseDate}</td>
                    <td>${p.supplier}</td>
                    <td>NT$ ${p.totalAmount.toFixed(2)}</td>
                    <td>${p.approver || 'N/A'}</td>
                    <td>${p.approvalTime || 'N/A'}</td>
                    <td>
                        <button class="btn btn-primary" onclick="viewPurchaseDetail('${p.purchaseNo}')">æŸ¥çœ‹è©³æƒ…</button>
                        <button class="btn btn-success" onclick="downloadPurchaseExcel('${p.purchaseNo}')">ä¸‹è¼‰Excel</button>
                    </td>
                `;
            });
        }

        // ä¸‹è¼‰å–®å€‹è«‹è³¼å–®ç‚ºExcel
        function downloadProcurementExcel(procurementNo) {
            const procurement = procurements.find(p => p.procurementNo === procurementNo);
            if (!procurement) {
                alert('æ‰¾ä¸åˆ°è©²è«‹è³¼å–®ï¼');
                return;
            }

            const ws_data = [
                ['è«‹è³¼å–®è™Ÿ:', procurement.procurementNo],
                ['ç”³è«‹æ—¥æœŸ:', procurement.applyDate],
                ['ç”³è«‹éƒ¨é–€:', procurement.department],
                ['ç”³è«‹äºº:', procurement.applicantName],
                ['è«‹è³¼äº‹ç”±:', procurement.procurementReason],
                [], // ç©ºè¡Œ
                ['è«‹è³¼å“é …'],
                ['é¡åˆ¥', 'åç¨±', 'è¦æ ¼', 'æ•¸é‡', 'å–®ä½', 'é ä¼°å–®åƒ¹', 'å°è¨ˆ']
            ];

            procurement.items.forEach(item => {
                ws_data.push([
                    item.category,
                    item.name,
                    item.spec,
                    item.quantity,
                    item.unit,
                    item.estimatedUnitPrice,
                    item.subtotal
                ]);
            });

            ws_data.push([]); // ç©ºè¡Œ
            ws_data.push(['ç¸½é‡‘é¡:', '', '', '', '', '', procurement.totalAmount]);
            ws_data.push([]);
            ws_data.push(['æ ¸å‡†ç‹€æ…‹:', procurement.status]);
            if (procurement.approver) {
                ws_data.push(['æ ¸å‡†äºº:', procurement.approver]);
                ws_data.push(['æ ¸å‡†æ™‚é–“:', procurement.approvalTime]);
            }
            if (procurement.rejectReason) {
                ws_data.push(['é§å›åŸå› :', procurement.rejectReason]);
            }

            const ws = XLSX.utils.aoa_to_sheet(ws_data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "è«‹è³¼å–®è©³æƒ…");
            XLSX.writeFile(wb, `${procurement.procurementNo}.xlsx`);
            addLog('ä¸‹è¼‰è«‹è³¼å–®Excel', `ä¸‹è¼‰è«‹è³¼å–®è™Ÿ: ${procurementNo} çš„Excelæª”æ¡ˆã€‚`);
        }

        // ä¸‹è¼‰å–®å€‹æ¡è³¼å–®ç‚ºExcel
        function downloadPurchaseExcel(purchaseNo) {
            const purchase = purchases.find(p => p.purchaseNo === purchaseNo);
            if (!purchase) {
                alert('æ‰¾ä¸åˆ°è©²æ¡è³¼å–®ï¼');
                return;
            }

            const ws_data = [
                ['æ¡è³¼å–®è™Ÿ:', purchase.purchaseNo],
                ['æ¡è³¼æ—¥æœŸ:', purchase.purchaseDate],
                ['ä¾›æ‡‰å•†:', purchase.supplier],
                ['è¯çµ¡äºº:', purchase.contactPerson],
                ['å‚™è¨»:', purchase.purchaseNote],
                [], // ç©ºè¡Œ
                ['æ¡è³¼å“é …'],
                ['å“é …ç·¨è™Ÿ', 'å“é …åç¨±', 'è¦æ ¼', 'æ•¸é‡', 'å–®ä½', 'å–®åƒ¹', 'å°è¨ˆ']
            ];

            purchase.items.forEach(item => {
                ws_data.push([
                    item.id || '',
                    item.name,
                    item.spec,
                    item.quantity,
                    item.unit,
                    item.unitPrice,
                    item.subtotal
                ]);
            });

            ws_data.push([]); // ç©ºè¡Œ
            ws_data.push(['ç¸½é‡‘é¡:', '', '', '', '', '', purchase.totalAmount]);
            ws_data.push([]);
            ws_data.push(['æ ¸å‡†ç‹€æ…‹:', purchase.status]);
            if (purchase.approver) {
                ws_data.push(['æ ¸å‡†äºº:', purchase.approver]);
                ws_data.push(['æ ¸å‡†æ™‚é–“:', purchase.approvalTime]);
            }
            if (purchase.rejectReason) {
                ws_data.push(['é§å›åŸå› :', purchase.rejectReason]);
            }

            const ws = XLSX.utils.aoa_to_sheet(ws_data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "æ¡è³¼å–®è©³æƒ…");
            XLSX.writeFile(wb, `${purchase.purchaseNo}.xlsx`);
            addLog('ä¸‹è¼‰æ¡è³¼å–®Excel', `ä¸‹è¼‰æ¡è³¼å–®è™Ÿ: ${purchaseNo} çš„Excelæª”æ¡ˆã€‚`);
        }

        // ä¸‹è¼‰æ‰€æœ‰å·²æ ¸å‡†è«‹è³¼å–®ç‚ºä¸€å€‹Excel
        function downloadAllApproved() {
            const approvedProcurements = procurements.filter(p => p.status === 'approved');
            if (approvedProcurements.length === 0) {
                alert('ç›®å‰æ²’æœ‰å·²æ ¸å‡†çš„è«‹è³¼å–®å¯ä¾›ä¸‹è¼‰ï¼');
                return;
            }

            const wb = XLSX.utils.book_new();

            approvedProcurements.forEach(procurement => {
                const ws_data = [
                    ['è«‹è³¼å–®è™Ÿ:', procurement.procurementNo],
                    ['ç”³è«‹æ—¥æœŸ:', procurement.applyDate],
                    ['ç”³è«‹éƒ¨é–€:', procurement.department],
                    ['ç”³è«‹äºº:', procurement.applicantName],
                    ['è«‹è³¼äº‹ç”±:', procurement.procurementReason],
                    [], // ç©ºè¡Œ
                    ['è«‹è³¼å“é …'],
                    ['é¡åˆ¥', 'åç¨±', 'è¦æ ¼', 'æ•¸é‡', 'å–®ä½', 'é ä¼°å–®åƒ¹', 'å°è¨ˆ']
                ];

                procurement.items.forEach(item => {
                    ws_data.push([
                        item.category,
                        item.name,
                        item.spec,
                        item.quantity,
                        item.unit,
                        item.estimatedUnitPrice,
                        item.subtotal
                    ]);
                });

                ws_data.push([]); // ç©ºè¡Œ
                ws_data.push(['ç¸½é‡‘é¡:', '', '', '', '', '', procurement.totalAmount]);
                ws_data.push([]);
                ws_data.push(['æ ¸å‡†ç‹€æ…‹:', procurement.status]);
                if (procurement.approver) {
                    ws_data.push(['æ ¸å‡†äºº:', procurement.approver]);
                    ws_data.push(['æ ¸å‡†æ™‚é–“:', procurement.approvalTime]);
                }

                const ws = XLSX.utils.aoa_to_sheet(ws_data);
                XLSX.utils.book_append_sheet(wb, ws, procurement.procurementNo); // ä»¥è«‹è³¼å–®è™Ÿä½œç‚ºå·¥ä½œè¡¨åç¨±
            });

            XLSX.writeFile(wb, "æ‰€æœ‰å·²æ ¸å‡†è«‹è³¼å–®.xlsx");
            addLog('ä¸‹è¼‰æ‰€æœ‰å·²æ ¸å‡†è«‹è³¼å–®', 'ä¸‹è¼‰äº†æ‰€æœ‰å·²æ ¸å‡†è«‹è³¼å–®çš„Excelæª”æ¡ˆã€‚');
        }


        // é¡¯ç¤ºå·²é§å›é¡å‹
        function showRejectedType(type) {
            document.getElementById('rejectedProcurementSection').style.display = 'none';
            document.getElementById('rejectedPurchaseSection').style.display = 'none';
            if (type === 'procurement') {
                document.getElementById('rejectedProcurementSection').style.display = 'block';
                renderRejectedProcurements();
            } else if (type === 'purchase') {
                document.getElementById('rejectedPurchaseSection').style.display = 'block';
                renderRejectedPurchases();
            }
        }

        // æ¸²æŸ“å·²é§å›è«‹è³¼å–®
        function renderRejectedProcurements() {
            const tableBody = document.getElementById('rejectedProcurementTable');
            tableBody.innerHTML = '';
            const rejected = procurements.filter(p => p.status === 'rejected');
            if (rejected.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="7" style="text-align: center;">ç›®å‰æ²’æœ‰å·²é§å›çš„è«‹è³¼å–®ã€‚</td></tr>';
                return;
            }

            rejected.forEach(p => {
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td>${p.procurementNo}</td>
                    <td>${p.applyDate}</td>
                    <td>${p.department}</td>
                    <td>${p.applicantName}</td>
                    <td>${p.approver || 'N/A'}</td>
                    <td>${p.approvalTime || 'N/A'}</td>
                    <td>${p.rejectReason || 'ç„¡'}</td>
                `;
            });
        }

        // æ¸²æŸ“å·²é§å›æ¡è³¼å–®
        function renderRejectedPurchases() {
            const tableBody = document.getElementById('rejectedPurchaseTable');
            tableBody.innerHTML = '';
            const rejected = purchases.filter(p => p.status === 'rejected');
            if (rejected.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="8" style="text-align: center;">ç›®å‰æ²’æœ‰å·²é§å›çš„æ¡è³¼å–®ã€‚</td></tr>';
                return;
            }

            rejected.forEach(p => {
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td>${p.purchaseNo}</td>
                    <td>${p.purchaseDate}</td>
                    <td>${p.supplier}</td>
                    <td>NT$ ${p.totalAmount.toFixed(2)}</td>
                    <td>${p.approver || 'N/A'}</td>
                    <td>${p.approvalTime || 'N/A'}</td>
                    <td>${p.rejectReason || 'ç„¡'}</td>
                `;
            });
        }


        // æ¡è³¼å–®é …ç›®ç®¡ç†
        function addPurchaseItem() {
            const tableBody = document.getElementById('purchaseItemsTableBody');
            const newRow = tableBody.insertRow();
            newRow.innerHTML = `
                <td><input type="text" placeholder="å“é …ç·¨è™Ÿ"></td>
                <td><input type="text" placeholder="å“é …åç¨±"></td>
                <td><input type="text" placeholder="è¦æ ¼"></td>
                <td><input type="number" min="1" value="1" onchange="calculatePurchaseSubtotal(this.parentNode.parentNode)"></td>
                <td><input type="text" placeholder="å–®ä½"></td>
                <td><input type="number" min="0" step="0.01" value="0" onchange="calculatePurchaseSubtotal(this.parentNode.parentNode)"></td>
                <td class="subtotal">0</td>
                <td><button type="button" class="btn btn-danger btn-sm" onclick="deletePurchaseItem(this)">åˆªé™¤</button></td>
            `;
            calculatePurchaseTotalAmount();
        }

        function deletePurchaseItem(button) {
            button.parentNode.parentNode.remove();
            calculatePurchaseTotalAmount();
        }

        function calculatePurchaseSubtotal(row) {
            const quantity = parseFloat(row.cells[3].querySelector('input').value) || 0;
            const unitPrice = parseFloat(row.cells[5].querySelector('input').value) || 0;
            const subtotal = quantity * unitPrice;
            row.cells[6].textContent = subtotal.toFixed(2);
            calculatePurchaseTotalAmount();
        }

        function calculatePurchaseTotalAmount() {
            let total = 0;
            const tableBody = document.getElementById('purchaseItemsTableBody');
            for (let i = 0; i < tableBody.rows.length; i++) {
                total += parseFloat(tableBody.rows[i].cells[6].textContent) || 0;
            }
            document.getElementById('purchaseTotalAmount').textContent = total.toFixed(2);
        }

        // æäº¤æ¡è³¼å–®
        function submitPurchase() {
            const purchaseNo = document.getElementById('purchaseNo').value;
            const purchaseDate = document.getElementById('purchaseDate').value;
            const supplier = document.getElementById('supplier').value;
            const contactPerson = document.getElementById('contactPerson').value;
            const purchaseNote = document.getElementById('purchaseNote').value;

            if (!purchaseNo || !purchaseDate || !supplier || !contactPerson) {
                alert('è«‹å¡«å¯«æ‰€æœ‰æ¡è³¼å–®åŸºæœ¬è³‡è¨Šï¼');
                return;
            }

            const items = [];
            const tableBody = document.getElementById('purchaseItemsTableBody');
            if (tableBody.rows.length === 0) {
                alert('è«‹è‡³å°‘æ–°å¢ä¸€å€‹æ¡è³¼å“é …ï¼');
                return;
            }

            for (let i = 0; i < tableBody.rows.length; i++) {
                const row = tableBody.rows[i];
                const item = {
                    id: row.cells[0].querySelector('input').value,
                    name: row.cells[1].querySelector('input').value,
                    spec: row.cells[2].querySelector('input').value,
                    quantity: parseFloat(row.cells[3].querySelector('input').value),
                    unit: row.cells[4].querySelector('input').value,
                    unitPrice: parseFloat(row.cells[5].querySelector('input').value),
                    subtotal: parseFloat(row.cells[6].textContent)
                };
                if (!item.name || !item.spec || item.quantity <= 0 || !item.unit || item.unitPrice < 0) {
                    alert('è«‹æª¢æŸ¥æ‰€æœ‰æ¡è³¼å“é …çš„è³‡è¨Šæ˜¯å¦å¡«å¯«å®Œæ•´ä¸”æ­£ç¢ºï¼');
                    return;
                }
                items.push(item);
            }

            const totalAmount = parseFloat(document.getElementById('purchaseTotalAmount').textContent);

            const newPurchase = {
                id: purchases.length + 1,
                purchaseNo: purchaseNo,
                purchaseDate: purchaseDate,
                supplier: supplier,
                contactPerson: contactPerson,
                purchaseNote: purchaseNote,
                items: items,
                totalAmount: totalAmount,
                status: 'pending', // åˆå§‹ç‹€æ…‹ç‚ºå¾…ç°½æ ¸
                approver: null,
                approvalTime: null,
                rejectReason: null
            };

            purchases.unshift(newPurchase);
            saveData();
            alert('æ¡è³¼å–®æäº¤æˆåŠŸï¼Œç­‰å¾…ç°½æ ¸ï¼');
            addLog('æäº¤æ¡è³¼å–®', `æäº¤æ¡è³¼å–®è™Ÿ: ${purchaseNo}`);
            resetPurchaseForm();
            updatePendingCount();
        }

        // é‡ç½®æ¡è³¼è¡¨å–®
        function resetPurchaseForm() {
            document.getElementById('purchaseForm').reset();
            document.getElementById('purchaseItemsTableBody').innerHTML = '';
            document.getElementById('purchaseTotalAmount').textContent = '0';
            generatePurchaseNo();
            document.getElementById('purchaseDate').valueAsDate = new Date();
        }

        // åº«å­˜ç®¡ç†åŠŸèƒ½

        // æ¸²æŸ“åº«å­˜åˆ—è¡¨
        function renderInventory() {
            const tableBody = document.getElementById('inventoryTableBody');
            tableBody.innerHTML = '';
            const searchTerm = document.getElementById('inventorySearch').value.toLowerCase();

            const filteredInventory = inventory.filter(item =>
                item.name.toLowerCase().includes(searchTerm) ||
                item.id.toLowerCase().includes(searchTerm)
            );

            if (filteredInventory.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="8" style="text-align: center;">æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„åº«å­˜å“é …ã€‚</td></tr>';
                return;
            }

            filteredInventory.forEach(item => {
                const row = tableBody.insertRow();
                let stockStatusClass = '';
                if (item.currentStock <= item.safetyStock) {
                    stockStatusClass = 'status-pending'; // ç”¨é»ƒè‰²è¡¨ç¤ºä½åº«å­˜
                }
                if (item.currentStock === 0) {
                    stockStatusClass = 'status-rejected'; // ç”¨ç´…è‰²è¡¨ç¤ºç¼ºè²¨
                }

                row.innerHTML = `
                    <td>${item.id}</td>
                    <td>${item.name}</td>
                    <td>${item.spec}</td>
                    <td>${item.unit}</td>
                    <td><span class="status-badge ${stockStatusClass}">${item.currentStock}</span></td>
                    <td>${item.safetyStock}</td>
                    <td>${item.supplier}</td>
                    <td>
                        <button class="btn btn-primary btn-sm" onclick="openEditInventoryItemModal('${item.id}')">ç·¨è¼¯</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteInventoryItem('${item.id}')">åˆªé™¤</button>
                    </td>
                `;
            });
        }

        // éæ¿¾åº«å­˜åˆ—è¡¨
        function filterInventory() {
            renderInventory();
        }

        // æ›´æ–°åº«å­˜çµ±è¨ˆæ•¸æ“š
        function updateInventoryStats() {
            let lowStock = 0;
            let outOfStock = 0;
            inventory.forEach(item => {
                if (item.currentStock === 0) {
                    outOfStock++;
                } else if (item.currentStock <= item.safetyStock) {
                    lowStock++;
                }
            });
            document.getElementById('lowStockCount').textContent = lowStock;
            document.getElementById('outOfStockCount').textContent = outOfStock;
            document.getElementById('totalItemsCount').textContent = inventory.length;
        }

        // é–‹å•Ÿæ–°å¢åº«å­˜å“é …æ¨¡æ…‹æ¡†
        function openAddItemModal() {
            document.getElementById('addInventoryItemModal').style.display = 'block';
            document.getElementById('newItemId').value = '';
            document.getElementById('newItemName').value = '';
            document.getElementById('newItemSpec').value = '';
            document.getElementById('newItemUnit').value = '';
            document.getElementById('newItemCurrentStock').value = '0';
            document.getElementById('newItemSafetyStock').value = '0';
            document.getElementById('newItemSupplier').value = '';
        }

        // æ–°å¢åº«å­˜å“é …
        function addNewInventoryItem() {
            const newItemId = document.getElementById('newItemId').value.trim();
            const newItemName = document.getElementById('newItemName').value.trim();
            const newItemSpec = document.getElementById('newItemSpec').value.trim();
            const newItemUnit = document.getElementById('newItemUnit').value.trim();
            const newItemCurrentStock = parseInt(document.getElementById('newItemCurrentStock').value);
            const newItemSafetyStock = parseInt(document.getElementById('newItemSafetyStock').value);
            const newItemSupplier = document.getElementById('newItemSupplier').value.trim();

            if (!newItemId || !newItemName || !newItemSpec || !newItemUnit || isNaN(newItemCurrentStock) || isNaN(newItemSafetyStock) || !newItemSupplier) {
                alert('è«‹å¡«å¯«æ‰€æœ‰åº«å­˜å“é …è³‡è¨Šï¼');
                return;
            }
            if (inventory.some(item => item.id === newItemId)) {
                alert('å“é …ç·¨è™Ÿå·²å­˜åœ¨ï¼Œè«‹ä½¿ç”¨ä¸åŒçš„ç·¨è™Ÿï¼');
                return;
            }

            inventory.unshift({ // æ–°å¢åˆ°æœ€å‰é¢
                id: newItemId,
                name: newItemName,
                spec: newItemSpec,
                unit: newItemUnit,
                currentStock: newItemCurrentStock,
                safetyStock: newItemSafetyStock,
                supplier: newItemSupplier
            });
            saveData();
            alert('æ–°åº«å­˜å“é …æ–°å¢æˆåŠŸï¼');
            addLog('æ–°å¢åº«å­˜å“é …', `æ–°å¢å“é …: ${newItemName} (ç·¨è™Ÿ: ${newItemId})`);
            renderInventory();
            updateInventoryStats();
            closeModal('addInventoryItemModal');
        }

        // é–‹å•Ÿç·¨è¼¯åº«å­˜å“é …æ¨¡æ…‹æ¡†
        function openEditInventoryItemModal(itemId) {
            const item = inventory.find(i => i.id === itemId);
            if (!item) return;

            document.getElementById('editItemOriginalId').value = item.id; // ä¿å­˜åŸå§‹ID
            document.getElementById('editItemId').value = item.id;
            document.getElementById('editItemName').value = item.name;
            document.getElementById('editItemSpec').value = item.spec;
            document.getElementById('editItemUnit').value = item.unit;
            document.getElementById('editItemCurrentStock').value = item.currentStock;
            document.getElementById('editItemSafetyStock').value = item.safetyStock;
            document.getElementById('editItemSupplier').value = item.supplier;
            document.getElementById('editInventoryItemModal').style.display = 'block';
        }

        // æ›´æ–°åº«å­˜å“é …
        function updateInventoryItem() {
            const originalId = document.getElementById('editItemOriginalId').value;
            const editItemId = document.getElementById('editItemId').value.trim();
            const editItemName = document.getElementById('editItemName').value.trim();
            const editItemSpec = document.getElementById('editItemSpec').value.trim();
            const editItemUnit = document.getElementById('editItemUnit').value.trim();
            const editItemCurrentStock = parseInt(document.getElementById('editItemCurrentStock').value);
            const editItemSafetyStock = parseInt(document.getElementById('editItemSafetyStock').value);
            const editItemSupplier = document.getElementById('editItemSupplier').value.trim();

            if (!editItemId || !editItemName || !editItemSpec || !editItemUnit || isNaN(editItemCurrentStock) || isNaN(editItemSafetyStock) || !editItemSupplier) {
                alert('è«‹å¡«å¯«æ‰€æœ‰åº«å­˜å“é …è³‡è¨Šï¼');
                return;
            }

            const itemIndex = inventory.findIndex(item => item.id === originalId);
            if (itemIndex !== -1) {
                inventory[itemIndex] = {
                    id: editItemId,
                    name: editItemName,
                    spec: editItemSpec,
                    unit: editItemUnit,
                    currentStock: editItemCurrentStock,
                    safetyStock: editItemSafetyStock,
                    supplier: editItemSupplier
                };
                saveData();
                alert('åº«å­˜å“é …æ›´æ–°æˆåŠŸï¼');
                addLog('æ›´æ–°åº«å­˜å“é …', `æ›´æ–°å“é …: ${editItemName} (ç·¨è™Ÿ: ${editItemId})`);
                renderInventory();
                updateInventoryStats();
                closeModal('editInventoryItemModal');
            }
        }

        // åˆªé™¤åº«å­˜å“é …
        function deleteInventoryItem(itemId) {
            if (confirm(`ç¢ºå®šè¦åˆªé™¤å“é …ç·¨è™Ÿ ${itemId} å—ï¼Ÿæ­¤æ“ä½œä¸å¯é€†ï¼`)) {
                inventory = inventory.filter(item => item.id !== itemId);
                saveData();
                alert('åº«å­˜å“é …å·²åˆªé™¤ï¼');
                addLog('åˆªé™¤åº«å­˜å“é …', `åˆªé™¤å“é …ç·¨è™Ÿ: ${itemId}`);
                renderInventory();
                updateInventoryStats();
            }
        }

        // è™•ç†Excelä¸Šå‚³
        function handleExcelUpload(event) {
            const file = event.target.files[0];
            const fileNameSpan = document.getElementById('uploadFileName');
            const uploadStatusDiv = document.getElementById('uploadStatus');

            if (!file) {
                fileNameSpan.textContent = 'æœªé¸æ“‡æª”æ¡ˆ';
                uploadStatusDiv.style.display = 'none';
                return;
            }

            fileNameSpan.textContent = `å·²é¸æ“‡æª”æ¡ˆ: ${file.name}`;
            uploadStatusDiv.style.display = 'block';
            uploadStatusDiv.className = 'upload-status status-info';
            uploadStatusDiv.textContent = 'æ­£åœ¨è®€å–æª”æ¡ˆ...';

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const json = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                    // å‡è¨­Excelç¬¬ä¸€è¡Œç‚ºæ¨™é¡Œï¼Œå¾ç¬¬äºŒè¡Œé–‹å§‹è®€å–æ•¸æ“š
                    if (json.length < 2) {
                        uploadStatusDiv.className = 'upload-status status-error';
                        uploadStatusDiv.textContent = 'Excelæª”æ¡ˆå…§å®¹ä¸è¶³ï¼Œè«‹ç¢ºä¿åŒ…å«æ¨™é¡Œå’Œæ•¸æ“šã€‚';
                        return;
                    }

                    // æª¢æŸ¥æ¨™é¡Œåˆ—ï¼Œç¢ºä¿æ ¼å¼æ­£ç¢º
                    const headers = json[0].map(h => typeof h === 'string' ? h.trim() : '');
                    const expectedHeaders = ['å“é …ç·¨è™Ÿ', 'å“é …åç¨±', 'è¦æ ¼', 'å–®ä½', 'ç›®å‰åº«å­˜', 'å®‰å…¨åº«å­˜', 'ä¾›æ‡‰å•†'];

                    const missingHeaders = expectedHeaders.filter(header => !headers.includes(header));
                    if (missingHeaders.length > 0) {
                        uploadStatusDiv.className = 'upload-status status-error';
                        uploadStatusDiv.textContent = `Excelæ¨™é¡Œä¸ç¬¦ã€‚ç¼ºå°‘ï¼š${missingHeaders.join(', ')}ã€‚è«‹ç¢ºä¿æ¨™é¡Œåˆ—åŒ…å«ï¼š${expectedHeaders.join(', ')}ã€‚`;
                        return;
                    }

                    const newInventoryData = [];
                    for (let i = 1; i < json.length; i++) {
                        const rowData = json[i];
                        if (rowData.length >= expectedHeaders.length && rowData.some(cell => cell !== undefined && cell !== '')) { // ç¢ºä¿è¡Œæœ‰æ•¸æ“š
                            const item = {};
                            expectedHeaders.forEach((header, index) => {
                                const headerIndex = headers.indexOf(header);
                                if (headerIndex !== -1) {
                                    item[convertHeaderToKey(header)] = rowData[headerIndex];
                                }
                            });
                            newInventoryData.push({
                                id: String(item.id || ''),
                                name: String(item.name || ''),
                                spec: String(item.spec || ''),
                                unit: String(item.unit || ''),
                                currentStock: Number(item.currentStock) || 0,
                                safetyStock: Number(item.safetyStock) || 0,
                                supplier: String(item.supplier || '')
                            });
                        }
                    }

                    // åˆä½µæˆ–æ›¿æ›ç¾æœ‰åº«å­˜
                    // é€™è£¡é¸æ“‡æ›¿æ›æ¨¡å¼ï¼šæ–°ä¸Šå‚³çš„ Excel å°‡å®Œå…¨å–ä»£ç¾æœ‰åº«å­˜
                    inventory = newInventoryData;
                    saveData();
                    renderInventory();
                    updateInventoryStats();
                    uploadStatusDiv.className = 'upload-status status-success';
                    uploadStatusDiv.textContent = `æª”æ¡ˆ "${file.name}" ä¸Šå‚³æˆåŠŸï¼Œå·²æ›´æ–°åº«å­˜æ•¸æ“šã€‚å…±è¼‰å…¥ ${newInventoryData.length} æ¢è¨˜éŒ„ã€‚`;
                    addLog('ä¸Šå‚³åº«å­˜Excel', `å¾æª”æ¡ˆ "${file.name}" æ›´æ–°äº†åº«å­˜æ•¸æ“šã€‚`);

                } catch (error) {
                    console.error('Error processing Excel file:', error);
                    uploadStatusDiv.className = 'upload-status status-error';
                    uploadStatusDiv.textContent = `è™•ç†æª”æ¡ˆæ™‚ç™¼ç”ŸéŒ¯èª¤: ${error.message}ã€‚è«‹ç¢ºèªæª”æ¡ˆæ ¼å¼æ˜¯å¦æ­£ç¢ºã€‚`;
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function convertHeaderToKey(header) {
            switch (header) {
                case 'å“é …ç·¨è™Ÿ': return 'id';
                case 'å“é …åç¨±': return 'name';
                case 'è¦æ ¼': return 'spec';
                case 'å–®ä½': return 'unit';
                case 'ç›®å‰åº«å­˜': return 'currentStock';
                case 'å®‰å…¨åº«å­˜': return 'safetyStock';
                case 'ä¾›æ‡‰å•†': return 'supplier';
                default: return header;
            }
        }

        // ä¸‹è¼‰åº«å­˜ç‚ºExcel
        function downloadInventoryExcel() {
            if (inventory.length === 0) {
                alert('ç›®å‰æ²’æœ‰åº«å­˜æ•¸æ“šå¯ä¾›ä¸‹è¼‰ï¼');
                return;
            }

            const ws_data = [
                ['å“é …ç·¨è™Ÿ', 'å“é …åç¨±', 'è¦æ ¼', 'å–®ä½', 'ç›®å‰åº«å­˜', 'å®‰å…¨åº«å­˜', 'ä¾›æ‡‰å•†']
            ];

            inventory.forEach(item => {
                ws_data.push([
                    item.id,
                    item.name,
                    item.spec,
                    item.unit,
                    item.currentStock,
                    item.safetyStock,
                    item.supplier
                ]);
            });

            const ws = XLSX.utils.aoa_to_sheet(ws_data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "åº«å­˜æ¸…å–®");
            XLSX.writeFile(wb, "åº«å­˜æ¸…å–®.xlsx");
            addLog('ä¸‹è¼‰åº«å­˜Excel', 'ä¸‹è¼‰äº†åº«å­˜æ¸…å–®çš„Excelæª”æ¡ˆã€‚');
        }

        // ç³»çµ±ç®¡ç† - ä½¿ç”¨è€…ç®¡ç†

        // æ¸²æŸ“ä½¿ç”¨è€…åˆ—è¡¨
        function renderUsers() {
            const tableBody = document.getElementById('userTableBody');
            tableBody.innerHTML = '';
            users.forEach(user => {
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td>${user.username}</td>
                    <td>${user.fullname}</td>
                    <td>${user.role === 'admin' ? 'ç®¡ç†å“¡' : 'ç”³è«‹äºº'}</td>
                    <td>
                        <button class="btn btn-primary btn-sm" onclick="openEditUserModal('${user.username}')">ç·¨è¼¯</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteUser('${user.username}')">åˆªé™¤</button>
                    </td>
                `;
            });
        }

        // é–‹å•Ÿæ–°å¢ä½¿ç”¨è€…æ¨¡æ…‹æ¡†
        function openAddUserModal() {
            document.getElementById('addUserModal').style.display = 'block';
            document.getElementById('newUsername').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('newFullName').value = '';
            document.getElementById('newUserRole').value = 'applicant';
        }

        // æ–°å¢ä½¿ç”¨è€…
        function addNewUser() {
            const newUsername = document.getElementById('newUsername').value.trim();
            const newPassword = document.getElementById('newPassword').value.trim();
            const newFullName = document.getElementById('newFullName').value.trim();
            const newUserRole = document.getElementById('newUserRole').value;

            if (!newUsername || !newPassword || !newFullName) {
                alert('è«‹å¡«å¯«æ‰€æœ‰ä½¿ç”¨è€…è³‡è¨Šï¼');
                return;
            }
            if (users.some(u => u.username === newUsername)) {
                alert('å¸³è™Ÿå·²å­˜åœ¨ï¼Œè«‹ä½¿ç”¨å…¶ä»–å¸³è™Ÿï¼');
                return;
            }

            users.unshift({ // æ–°å¢åˆ°æœ€å‰é¢
                username: newUsername,
                password: newPassword,
                fullname: newFullName,
                role: newUserRole
            });
            saveData();
            alert('æ–°ä½¿ç”¨è€…æ–°å¢æˆåŠŸï¼');
            addLog('æ–°å¢ä½¿ç”¨è€…', `æ–°å¢ä½¿ç”¨è€…: ${newFullName} (å¸³è™Ÿ: ${newUsername})`);
            renderUsers();
            closeModal('addUserModal');
        }

        // é–‹å•Ÿç·¨è¼¯ä½¿ç”¨è€…æ¨¡æ…‹æ¡†
        function openEditUserModal(username) {
            const user = users.find(u => u.username === username);
            if (!user) return;

            document.getElementById('editUserOriginalUsername').value = user.username;
            document.getElementById('editUsername').value = user.username;
            document.getElementById('editPassword').value = ''; // ç·¨è¼¯æ™‚ä¸é¡¯ç¤ºèˆŠå¯†ç¢¼ï¼Œç•™ç©ºè¡¨ç¤ºä¸æ›´æ”¹
            document.getElementById('editFullName').value = user.fullname;
            document.getElementById('editUserRole').value = user.role;
            document.getElementById('editUserModal').style.display = 'block';
        }

        // æ›´æ–°ä½¿ç”¨è€…
        function updateUser() {
            const originalUsername = document.getElementById('editUserOriginalUsername').value;
            const editUsername = document.getElementById('editUsername').value.trim(); // å¸³è™Ÿä¸å¯ç·¨è¼¯
            const editPassword = document.getElementById('editPassword').value.trim();
            const editFullName = document.getElementById('editFullName').value.trim();
            const editUserRole = document.getElementById('editUserRole').value;

            if (!editUsername || !editFullName) {
                alert('è«‹å¡«å¯«ä½¿ç”¨è€…å§“åï¼');
                return;
            }

            const userIndex = users.findIndex(u => u.username === originalUsername);
            if (userIndex !== -1) {
                if (editPassword) { // å¦‚æœæœ‰è¼¸å…¥æ–°å¯†ç¢¼æ‰æ›´æ–°
                    users[userIndex].password = editPassword;
                }
                users[userIndex].fullname = editFullName;
                users[userIndex].role = editUserRole;
                saveData();
                alert('ä½¿ç”¨è€…è³‡è¨Šæ›´æ–°æˆåŠŸï¼');
                addLog('æ›´æ–°ä½¿ç”¨è€…', `æ›´æ–°ä½¿ç”¨è€…: ${editFullName} (å¸³è™Ÿ: ${editUsername})`);
                renderUsers();
                closeModal('editUserModal');
            }
        }

        // åˆªé™¤ä½¿ç”¨è€…
        function deleteUser(username) {
            if (confirm(`ç¢ºå®šè¦åˆªé™¤å¸³è™Ÿ ${username} å—ï¼Ÿæ­¤æ“ä½œä¸å¯é€†ï¼`)) {
                if (users.length === 1) {
                    alert('ä¸èƒ½åˆªé™¤æœ€å¾Œä¸€å€‹ä½¿ç”¨è€…ï¼');
                    return;
                }
                users = users.filter(user => user.username !== username);
                saveData();
                alert('ä½¿ç”¨è€…å·²åˆªé™¤ï¼');
                addLog('åˆªé™¤ä½¿ç”¨è€…', `åˆªé™¤ä½¿ç”¨è€…å¸³è™Ÿ: ${username}`);
                renderUsers();
            }
        }

        // æ¸²æŸ“ç³»çµ±æ—¥èªŒ
        function renderLogs() {
            const tableBody = document.getElementById('logTableBody');
            tableBody.innerHTML = '';
            if (logs.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="4" style="text-align: center;">ç›®å‰æ²’æœ‰ç³»çµ±æ—¥èªŒã€‚</td></tr>';
                return;
            }
            logs.forEach(log => {
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td>${log.timestamp}</td>
                    <td>${log.user}</td>
                    <td>${log.action}</td>
                    <td>${log.description}</td>
                `;
            });
        }

        // ä¸‹æ‹‰é¸å–®åŠŸèƒ½
        function toggleDropdown(dropdownId) {
            const dropdown = document.getElementById(dropdownId);
            dropdown.classList.toggle('show');
        }

        // é»æ“Šå¤–é¢é—œé–‰ä¸‹æ‹‰é¸å–®
        window.onclick = function(event) {
            if (!event.target.matches('.dropdown-btn')) {
                const dropdowns = document.querySelectorAll('.dropdown-content');
                dropdowns.forEach(openDropdown => {
                    if (openDropdown.classList.contains('show')) {
                        openDropdown.classList.remove('show');
                    }
                });
            }
        }

        // æ‰¹é‡å»ºç«‹æ¡è³¼å–®åŠŸèƒ½
        let selectedProcurementItems = []; // å„²å­˜é¸ä¸­è«‹è³¼å–®ä¸­çš„æ‰€æœ‰å“é …

        function updateSelectedCount() {
            const checkboxes = document.querySelectorAll('#approvedProcurementTable .approved-checkbox');
            let count = 0;
            checkboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    count++;
                }
            });
            document.getElementById('selectedCount').textContent = count;
        }

        function toggleAllApproved() {
            const selectAll = document.getElementById('selectAllCheckbox').checked;
            const checkboxes = document.querySelectorAll('#approvedProcurementTable .approved-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll;
            });
            updateSelectedCount();
        }

        function selectAllApproved() {
            document.getElementById('selectAllCheckbox').checked = true;
            toggleAllApproved();
        }

        function clearAllApproved() {
            document.getElementById('selectAllCheckbox').checked = false;
            toggleAllApproved();
        }

        function previewSelectedItems() {
            selectedProcurementItems = [];
            let totalPreviewAmount = 0;
            const checkboxes = document.querySelectorAll('#approvedProcurementTable .approved-checkbox:checked');
            if (checkboxes.length === 0) {
                alert('è«‹è‡³å°‘é¸æ“‡ä¸€å€‹è«‹è³¼å–®ä¾†é è¦½ã€‚');
                return;
            }

            const previewTableBody = document.getElementById('previewSelectedItemsTableBody');
            previewTableBody.innerHTML = '';

            checkboxes.forEach(checkbox => {
                const row = checkbox.closest('tr');
                const procurementNo = row.dataset.procurementNo;
                const procurement = procurements.find(p => p.procurementNo === procurementNo);
                if (procurement) {
                    procurement.items.forEach(item => {
                        selectedProcurementItems.push({
                            procurementNo: procurement.procurementNo,
                            name: item.name,
                            spec: item.spec,
                            quantity: item.quantity,
                            unit: item.unit,
                            estimatedUnitPrice: item.estimatedUnitPrice,
                            subtotal: item.subtotal
                        });
                        totalPreviewAmount += item.subtotal;

                        const newRow = previewTableBody.insertRow();
                        newRow.innerHTML = `
                            <td>${procurement.procurementNo}</td>
                            <td>${item.name}</td>
                            <td>${item.spec}</td>
                            <td>${item.quantity}</td>
                            <td>${item.unit}</td>
                            <td>${item.estimatedUnitPrice.toFixed(2)}</td>
                            <td>${item.subtotal.toFixed(2)}</td>
                        `;
                    });
                }
            });

            document.getElementById('previewTotalAmount').textContent = totalPreviewAmount.toFixed(2);
            document.getElementById('previewSelectedItemsModal').style.display = 'block';
        }

        function confirmCreatePurchaseFromPreview() {
            if (selectedProcurementItems.length === 0) {
                alert('æ²’æœ‰é¸å–çš„é …ç›®å¯ä¾›å»ºç«‹æ¡è³¼å–®ã€‚');
                return;
            }

            // è½‰åˆ°å»ºç«‹æ¡è³¼å–®é é¢ï¼Œä¸¦é å¡«å…¥é …ç›®
            showPage('createPurchase');
            resetPurchaseForm(); // å…ˆæ¸…ç©ºï¼Œå†æ·»åŠ é¸ä¸­çš„é …ç›®

            const purchaseItemsTableBody = document.getElementById('purchaseItemsTableBody');
            let newPurchaseTotalAmount = 0;

            selectedProcurementItems.forEach(item => {
                const newRow = purchaseItemsTableBody.insertRow();
                newRow.innerHTML = `
                    <td><input type="text" value="" placeholder="å“é …ç·¨è™Ÿ (é¸å¡«)"></td>
                    <td><input type="text" value="${item.name}" placeholder="å“é …åç¨±"></td>
                    <td><input type="text" value="${item.spec}" placeholder="è¦æ ¼"></td>
                    <td><input type="number" min="1" value="${item.quantity}" onchange="calculatePurchaseSubtotal(this.parentNode.parentNode)"></td>
                    <td><input type="text" value="${item.unit}" placeholder="å–®ä½"></td>
                    <td><input type="number" min="0" step="0.01" value="${item.estimatedUnitPrice}" onchange="calculatePurchaseSubtotal(this.parentNode.parentNode)"></td>
                    <td class="subtotal">${item.subtotal.toFixed(2)}</td>
                    <td><button type="button" class="btn btn-danger btn-sm" onclick="deletePurchaseItem(this)">åˆªé™¤</button></td>
                `;
                newPurchaseTotalAmount += item.subtotal;
            });
            document.getElementById('purchaseTotalAmount').textContent = newPurchaseTotalAmount.toFixed(2);

            // æ¸…é™¤é¸ä¸­çš„è«‹è³¼å–®ï¼Œé˜²æ­¢é‡è¤‡æ“ä½œ
            clearAllApproved();
            selectedProcurementItems = []; // æ¸…ç©ºé è¦½æ•¸æ“š
            closeModal('previewSelectedItemsModal');
            alert('å·²å°‡é¸å–é …ç›®è‡ªå‹•å¸¶å…¥æ¡è³¼å–®ï¼è«‹ç¢ºèªå¾Œæäº¤ã€‚');
            addLog('æ‰¹é‡å»ºç«‹æ¡è³¼å–®', 'å¾å·²æ ¸å‡†è«‹è³¼å–®æ‰¹é‡å»ºç«‹æ¡è³¼å–®ã€‚');
        }


        // é é¢åŠ è¼‰æ™‚åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            // æª¢æŸ¥æ˜¯å¦å·²ç™»å…¥
            if (currentUser) {
                document.getElementById('currentUser').textContent = currentUser.fullname;
                document.getElementById('loginPage').style.display = 'none';
                document.getElementById('mainSystem').style.display = 'block';
                updateNavigationVisibility();
                showPage('newProcurement'); // é è¨­é¡¯ç¤ºæ–°å¢è«‹è³¼
            } else {
                document.getElementById('loginPage').style.display = 'flex';
                document.getElementById('mainSystem').style.display = 'none';
            }
            updatePendingCount(); // åˆå§‹åŒ–å¾…ç°½æ ¸è¨ˆæ•¸
            generateProcurementNo(); // ç”Ÿæˆåˆå§‹è«‹è³¼å–®è™Ÿ
            document.getElementById('applyDate').valueAsDate = new Date(); // è¨­ç½®åˆå§‹æ—¥æœŸ
            generatePurchaseNo(); // ç”Ÿæˆåˆå§‹æ¡è³¼å–®è™Ÿ
            document.getElementById('purchaseDate').valueAsDate = new Date(); // è¨­ç½®åˆå§‹æ—¥æœŸ
        });
    </script>
</body>
</html>
