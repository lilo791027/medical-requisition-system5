<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>上吉醫療-藥品醫材請購系統</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* 您的CSS代碼 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* 登入頁面 */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .login-form {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        .login-form h1 {
            color: #333;
            margin-bottom: 30px;
            font-size: 24px;
        }

        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: bold;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .login-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .login-btn:hover {
            transform: translateY(-2px);
        }

        /* 主系統介面 */
        .main-system {
            display: none;
        }

        .header {
            background: white;
            padding: 15px 30px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: #333;
            font-size: 24px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logout-btn {
            padding: 8px 16px;
            background: #ff4757;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .logout-btn:hover {
            background: #ff3742;
        }

        .nav-menu {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .nav-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
        }

        .nav-btn {
            padding: 12px 24px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
            position: relative;
        }

        .nav-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        }

        .nav-btn.active {
            background: linear-gradient(135deg, #2f3542, #40407a);
        }

        .notification-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #ff4757;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .content-area {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            min-height: 600px;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        /* 表單樣式 */
        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-col {
            flex: 1;
        }

        .form-col label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }

        .form-col input,
        .form-col select,
        .form-col textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .form-col textarea {
            height: 80px;
            resize: vertical;
        }

        /* 按鈕樣式 */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-success {
            background: #2ed573;
            color: white;
        }

        .btn-danger {
            background: #ff4757;
            color: white;
        }

        .btn-secondary {
            background: #57606f;
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        /* 表格樣式 */
        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .table th,
        .table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .table th {
            background: #f8f9fa;
            font-weight: bold;
            color: #333;
        }

        .table tr:hover {
            background: #f8f9fa;
        }

        /* 品項表格 */
        .items-table {
            margin-top: 20px;
            border: 2px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
        }

        .items-table th {
            background: #667eea;
            color: white;
        }

        /* 下拉選單 */
        .dropdown {
            position: relative;
            display: inline-block;
            margin-bottom: 20px;
        }

        .dropdown-btn {
            background: #667eea;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .dropdown-content {
            display: none;
            position: absolute;
            background: white;
            min-width: 160px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
            border-radius: 5px;
            z-index: 1;
        }

        .dropdown-content.show {
            display: block;
        }

        .dropdown-content a {
            color: #333;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
            transition: background 0.3s;
        }

        .dropdown-content a:hover {
            background: #f1f1f1;
        }

        /* 狀態標籤 */
        .status-badge {
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
        }

        .status-pending {
            background: #ffa726;
            color: white;
        }

        .status-approved {
            background: #66bb6a;
            color: white;
        }

        .status-rejected {
            background: #ef5350;
            color: white;
        }

        /* 搜尋框 */
        .search-box {
            width: 300px;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 25px;
            margin-bottom: 20px;
        }

        /* 庫存管理 */
        .inventory-stats {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            flex: 1;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-card h3 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .stat-card p {
            opacity: 0.9;
        }

        /* 檔案上傳 */
        .file-upload {
            border: 2px dashed #ddd;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            margin-bottom: 20px;
            transition: all 0.3s;
        }

        .file-upload:hover {
            border-color: #667eea;
            background: #f8f9fa;
        }

        .file-upload input[type="file"] {
            display: none;
        }

        /* 勾選框樣式 */
        .approved-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
            transform: scale(1.2);
        }

        .approved-checkbox:checked {
            accent-color: #667eea;
        }

        /* 選擇操作區域 */
        .selection-controls {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #dee2e6;
        }

        .selection-controls h4 {
            margin: 0 0 10px 0;
            color: #333;
        }

        /* 響應式設計 */
        @media (max-width: 768px) {
            .nav-buttons {
                flex-direction: column;
            }

            .form-row {
                flex-direction: column;
            }

            .inventory-stats {
                flex-direction: column;
            }

            .table {
                font-size: 12px;
            }

            .table th,
            .table td {
                padding: 8px;
            }

            .selection-controls {
                text-align: center;
            }

            .selection-controls .btn {
                margin: 5px;
                width: 100%;
            }
        }

        /* 模態框 */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #000;
        }

        .section-divider {
            border-top: 2px solid #eee;
            margin: 30px 0;
            padding-top: 20px;
        }

        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-danger {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        /* 上傳狀態樣式 */
        .upload-status {
            margin-bottom: 20px;
        }

        .status-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
            padding: 10px;
            border-radius: 5px;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            padding: 10px;
            border-radius: 5px;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            padding: 10px;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div id="loginPage" class="login-container">
        <div class="login-form">
            <h1>🏥 上吉醫療<br>藥品醫材請購系統</h1>
            <div class="form-group">
                <label for="username">帳號</label>
                <input type="text" id="username" placeholder="請輸入帳號">
            </div>
            <div class="form-group">
                <label for="password">密碼</label>
                <input type="password" id="password" placeholder="請輸入密碼">
            </div>
            <button class="login-btn" type="button" onclick="login()">登入系統</button>
        </div>
    </div>

    <div id="mainSystem" class="main-system">
        <div class="container">
            <div class="header">
                <h1>🏥 上吉醫療 - 藥品醫材請購系統</h1>
                <div class="user-info">
                    <span>歡迎，<span id="currentUser"></span></span>
                    <button class="logout-btn" onclick="logout()">登出</button>
                </div>
            </div>

            <div class="nav-menu">
                <div class="nav-buttons">
                    <button class="nav-btn active" onclick="showPage('newProcurement')">📝 新增請購</button>
                    <button class="nav-btn" onclick="showPage('approvalManagement')" id="approvalBtn">
                        ✅ 簽核管理
                        <span class="notification-badge" id="pendingCount" style="display: none;">0</span>
                    </button>
                    <button class="nav-btn" onclick="showPage('approved')">✔️ 已核准</button>
                    <button class="nav-btn" onclick="showPage('rejected')">🚫 已駁回</button>
                    <button class="nav-btn" onclick="showPage('createPurchase')">📝 建立採購單</button>
                    <button class="nav-btn" onclick="showPage('inventory')">📦 庫存管理</button>
                    <button class="nav-btn" onclick="showPage('systemAdmin')">🛠️ 系統管理</button>
                </div>
            </div>

            <div class="content-area">
                <div id="newProcurement" class="page active">
                    <h2>📝 新增請購單</h2>
                    <form id="procurementForm">
                        <div class="form-row">
                            <div class="form-col">
                                <label>請購單號</label>
                                <input type="text" id="procurementNo" readonly>
                            </div>
                            <div class="form-col">
                                <label>申請日期</label>
                                <input type="date" id="applyDate">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-col">
                                <label>申請部門</label>
                                <select id="department">
                                    <option value="">請選擇部門</option>
                                    <option value="內科">內科</option>
                                    <option value="外科">外科</option>
                                    <option value="急診科">急診科</option>
                                    <option value="藥劑科">藥劑科</option>
                                    <option value="護理部">護理部</option>
                                    <option value="行政部">行政部</option>
                                </select>
                            </div>
                            <div class="form-col">
                                <label>申請人姓名</label>
                                <input type="text" id="applicantName">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-col">
                                <label>請購事由</label>
                                <textarea id="procurementReason" placeholder="請詳細說明請購事由..."></textarea>
                            </div>
                        </div>
                       
                        <h3>請購品項</h3>
                        <button type="button" class="btn btn-primary" onclick="addItem()">➕ 新增品項</button>
                       
                        <table class="table items-table" id="itemsTable">
                            <thead>
                                <tr>
                                    <th>類別</th>
                                    <th>名稱</th>
                                    <th>規格</th>
                                    <th>數量</th>
                                    <th>單位</th>
                                    <th>預估單價</th>
                                    <th>小計</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="itemsTableBody">
                            </tbody>
                        </table>
                       
                        <div style="margin-top: 20px; text-align: right;">
                            <strong>總金額：NT$ <span id="totalAmount">0</span></strong>
                        </div>
                       
                        <div style="margin-top: 30px;">
                            <button type="button" class="btn btn-success" onclick="submitProcurement()">📤 提交請購單</button>
                            <button type="button" class="btn btn-secondary" onclick="resetForm()">🔄 重設</button>
                        </div>
                    </form>
                </div>

                <div id="approvalManagement" class="page">
                    <h2>✅ 簽核管理</h2>
                   
                    <div class="dropdown">
                        <button class="dropdown-btn" onclick="toggleDropdown('approvalDropdown')">
                            選擇單據類型 ▼
                        </button>
                        <div class="dropdown-content" id="approvalDropdown">
                            <a href="#" onclick="showApprovalType('procurement')">1. 請購單</a>
                            <a href="#" onclick="showApprovalType('purchase')">2. 採購單</a>
                        </div>
                    </div>

                    <div id="procurementApproval" class="section-divider">
                        <h3>待審核請購單</h3>
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>請購單號</th>
                                    <th>申請日期</th>
                                    <th>申請部門</th>
                                    <th>申請人</th>
                                    <th>狀態</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="pendingProcurementTable">
                                </tbody>
                        </table>
                    </div>

                    <div id="purchaseApproval" class="section-divider" style="display: none;">
                        <h3>待審核採購單</h3>
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>採購單號</th>
                                    <th>採購日期</th>
                                    <th>供應商</th>
                                    <th>總金額</th>
                                    <th>狀態</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="pendingPurchaseTable">
                                </tbody>
                        </table>
                    </div>
                </div>

                <div id="approved" class="page">
                    <h2>✔️ 已核准</h2>
                   
                    <div class="dropdown">
                        <button class="dropdown-btn" onclick="toggleDropdown('approvedDropdown')">
                            選擇單據類型 ▼
                        </button>
                        <div class="dropdown-content" id="approvedDropdown">
                            <a href="#" onclick="showApprovedType('procurement')">1. 請購單</a>
                            <a href="#" onclick="showApprovedType('purchase')">2. 採購單</a>
                        </div>
                    </div>

                    <div style="margin: 20px 0;">
                        <button class="btn btn-primary" onclick="downloadAllApproved()">💾 全部下載請購單</button>
                    </div>

                    <div id="approvedProcurementSection">
                        <h3>已核准請購單</h3>
                       
                        <div class="selection-controls">
                            <h4>📝 批量建立採購單</h4>
                            <div style="display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                                <button class="btn btn-success" onclick="createPurchaseFromSelected()">
                                    📝 建立採購單 (<span id="selectedCount">0</span> 項)
                                </button>
                                <button class="btn btn-secondary" onclick="selectAllApproved()">☑️ 全選</button>
                                <button class="btn btn-secondary" onclick="clearAllApproved()">☐ 清除</button>
                                <button class="btn btn-primary" onclick="previewSelectedItems()">👁️ 預覽選擇</button>
                            </div>
                            <div class="selection-info" id="selectionInfo">
                                請勾選要建立採購單的請購項目，可以多選
                            </div>
                        </div>
                       
                        <table class="table">
                            <thead>
                                <tr>
                                    <th style="width: 60px;">
                                        <input type="checkbox" id="selectAllCheckbox" onchange="toggleAllApproved()" style="transform: scale(1.2);">
                                        <br><small>全選</small>
                                    </th>
                                    <th>請購單號</th>
                                    <th>申請日期</th>
                                    <th>申請部門</th>
                                    <th>申請人</th>
                                    <th>總金額</th>
                                    <th>核准人</th>
                                    <th>核准時間</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="approvedProcurementTable">
                                </tbody>
                        </table>
                    </div>

                    <div id="approvedPurchaseSection" style="display: none;">
                        <h3>已核准採購單</h3>
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>採購單號</th>
                                    <th>採購日期</th>
                                    <th>供應商</th>
                                    <th>總金額</th>
                                    <th>核准人</th>
                                    <th>核准時間</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="approvedPurchaseTable">
                                </tbody>
                        </table>
                    </div>
                </div>

                <div id="rejected" class="page">
                    <h2>🚫 已駁回</h2>
                   
                    <div class="dropdown">
                        <button class="dropdown-btn" onclick="toggleDropdown('rejectedDropdown')">
                            選擇單據類型 ▼
                        </button>
                        <div class="dropdown-content" id="rejectedDropdown">
                            <a href="#" onclick="showRejectedType('procurement')">1. 請購單</a>
                            <a href="#" onclick="showRejectedType('purchase')">2. 採購單</a>
                        </div>
                    </div>

                    <div id="rejectedProcurementSection">
                        <h3>已駁回請購單</h3>
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>請購單號</th>
                                    <th>申請日期</th>
                                    <th>申請部門</th>
                                    <th>申請人</th>
                                    <th>駁回人</th>
                                    <th>駁回時間</th>
                                    <th>駁回原因</th>
                                </tr>
                            </thead>
                            <tbody id="rejectedProcurementTable">
                                </tbody>
                        </table>
                    </div>

                    <div id="rejectedPurchaseSection" style="display: none;">
                        <h3>已駁回採購單</h3>
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>採購單號</th>
                                    <th>採購日期</th>
                                    <th>供應商</th>
                                    <th>總金額</th>
                                    <th>駁回人</th>
                                    <th>駁回時間</th>
                                    <th>駁回原因</th>
                                </tr>
                            </thead>
                            <tbody id="rejectedPurchaseTable">
                                </tbody>
                        </table>
                    </div>
                </div>

                <div id="createPurchase" class="page">
                    <h2>📝 建立採購單</h2>
                    <form id="purchaseForm">
                        <div class="form-row">
                            <div class="form-col">
                                <label>採購單號</label>
                                <input type="text" id="purchaseNo" readonly>
                            </div>
                            <div class="form-col">
                                <label>採購日期</label>
                                <input type="date" id="purchaseDate">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-col">
                                <label>供應商</label>
                                <select id="supplier">
                                    <option value="">請選擇供應商</option>
                                    <option value="台灣醫材公司">台灣醫材公司</option>
                                    <option value="康健醫療器材">康健醫療器材</option>
                                    <option value="優質藥品供應商">優質藥品供應商</option>
                                    <option value="專業醫材行">專業醫材行</option>
                                </select>
                            </div>
                            <div class="form-col">
                                <label>聯絡人</label>
                                <input type="text" id="contactPerson">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-col">
                                <label>備註</label>
                                <textarea id="purchaseNote" placeholder="請填寫採購備註..."></textarea>
                            </div>
                        </div>
                       
                        <h3>採購品項</h3>
                        <button type="button" class="btn btn-primary" onclick="addPurchaseItem()">➕ 新增品項</button>
                       
                        <table class="table items-table" id="purchaseItemsTable">
                            <thead>
                                <tr>
                                    <th>品項編號</th>
                                    <th>品項名稱</th>
                                    <th>規格</th>
                                    <th>數量</th>
                                    <th>單位</th>
                                    <th>單價</th>
                                    <th>小計</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="purchaseItemsTableBody">
                            </tbody>
                        </table>
                       
                        <div style="margin-top: 20px; text-align: right;">
                            <strong>總金額：NT$ <span id="purchaseTotalAmount">0</span></strong>
                        </div>
                       
                        <div style="margin-top: 30px;">
                            <button type="button" class="btn btn-success" onclick="submitPurchase()">📤 提交採購單</button>
                            <button type="button" class="btn btn-secondary" onclick="resetPurchaseForm()">🔄 重設</button>
                        </div>
                    </form>
                </div>

                <div id="inventory" class="page">
                    <h2>📦 庫存管理</h2>
                   
                    <div class="inventory-stats">
                        <div class="stat-card">
                            <h3 id="lowStockCount">0</h3>
                            <p>低庫存品項</p>
                        </div>
                        <div class="stat-card">
                            <h3 id="outOfStockCount">0</h3>
                            <p>缺貨品項</p>
                        </div>
                        <div class="stat-card">
                            <h3 id="totalItemsCount">0</h3>
                            <p>總品項數</p>
                        </div>
                    </div>

                    <div style="margin-bottom: 20px; display: flex; gap: 15px; flex-wrap: wrap;">
                        <div class="file-upload">
                            <input type="file" id="excelUpload" accept=".xlsx, .xls" onchange="handleExcelUpload(event)">
                            <label for="excelUpload" class="btn btn-primary">⬆️ 上傳庫存Excel</label>
                            <p id="uploadFileName" style="margin-top: 10px; color: #555;">未選擇檔案</p>
                            <div id="uploadStatus" class="upload-status" style="display: none;"></div>
                        </div>
                        <button class="btn btn-success" onclick="downloadInventoryExcel()">⬇️ 下載庫存Excel</button>
                        <button class="btn btn-secondary" onclick="openAddItemModal()">➕ 新增品項</button>
                        <input type="text" id="inventorySearch" class="search-box" placeholder="搜尋品項名稱或編號..." onkeyup="filterInventory()">
                    </div>
                   
                    <table class="table" id="inventoryTable">
                        <thead>
                            <tr>
                                <th>品項編號</th>
                                <th>品項名稱</th>
                                <th>規格</th>
                                <th>單位</th>
                                <th>目前庫存</th>
                                <th>安全庫存</th>
                                <th>供應商</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="inventoryTableBody">
                            </tbody>
                    </table>
                </div>

                <div id="systemAdmin" class="page">
                    <h2>🛠️ 系統管理</h2>
                   
                    <div class="section-divider">
                        <h3>使用者管理</h3>
                        <button class="btn btn-primary" onclick="openAddUserModal()">➕ 新增使用者</button>
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>帳號</th>
                                    <th>姓名</th>
                                    <th>角色</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="userTableBody">
                                </tbody>
                        </table>
                    </div>

                    <div class="section-divider">
                        <h3>角色與權限設定</h3>
                        <p>此功能為進階設定，目前系統角色固定為 '申請人' 和 '管理員'。</p>
                    </div>

                    <div class="section-divider">
                        <h3>系統日誌</h3>
                        <p>此處將顯示系統操作日誌。</p>
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>時間</th>
                                    <th>使用者</th>
                                    <th>操作</th>
                                    <th>描述</th>
                                </tr>
                            </thead>
                            <tbody id="logTableBody">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="procurementDetailModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('procurementDetailModal')">&times;</span>
            <h2>請購單詳情 - <span id="modalProcurementNo"></span></h2>
            <div class="form-row">
                <div class="form-col"><strong>申請日期:</strong> <span id="modalApplyDate"></span></div>
                <div class="form-col"><strong>申請部門:</strong> <span id="modalDepartment"></span></div>
            </div>
            <div class="form-row">
                <div class="form-col"><strong>申請人:</strong> <span id="modalApplicantName"></span></div>
                <div class="form-col"><strong>請購事由:</strong> <span id="modalProcurementReason"></span></div>
            </div>
            <h3>請購品項</h3>
            <table class="table items-table">
                <thead>
                    <tr>
                        <th>類別</th>
                        <th>名稱</th>
                        <th>規格</th>
                        <th>數量</th>
                        <th>單位</th>
                        <th>預估單價</th>
                        <th>小計</th>
                    </tr>
                </thead>
                <tbody id="modalItemsTableBody">
                </tbody>
            </table>
            <div style="margin-top: 20px; text-align: right;">
                <strong>總金額：NT$ <span id="modalTotalAmount">0</span></strong>
            </div>
            <div style="margin-top: 20px;" id="approvalActions">
                <button class="btn btn-success" onclick="approveProcurement()">✅ 核准</button>
                <button class="btn btn-danger" onclick="openRejectModal('procurement')">🚫 駁回</button>
            </div>
        </div>
    </div>

    <div id="purchaseDetailModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('purchaseDetailModal')">&times;</span>
            <h2>採購單詳情 - <span id="modalPurchaseNo"></span></h2>
            <div class="form-row">
                <div class="form-col"><strong>採購日期:</strong> <span id="modalPurchaseDate"></span></div>
                <div class="form-col"><strong>供應商:</strong> <span id="modalSupplier"></span></div>
            </div>
            <div class="form-row">
                <div class="form-col"><strong>聯絡人:</strong> <span id="modalContactPerson"></span></div>
                <div class="form-col"><strong>備註:</strong> <span id="modalPurchaseNote"></span></div>
            </div>
            <h3>採購品項</h3>
            <table class="table items-table">
                <thead>
                    <tr>
                        <th>品項編號</th>
                        <th>品項名稱</th>
                        <th>規格</th>
                        <th>數量</th>
                        <th>單位</th>
                        <th>單價</th>
                        <th>小計</th>
                    </tr>
                </thead>
                <tbody id="modalPurchaseItemsTableBody">
                </tbody>
            </table>
            <div style="margin-top: 20px; text-align: right;">
                <strong>總金額：NT$ <span id="modalPurchaseTotalAmount">0</span></strong>
            </div>
            <div style="margin-top: 20px;" id="purchaseApprovalActions">
                <button class="btn btn-success" onclick="approvePurchase()">✅ 核准採購單</button>
                <button class="btn btn-danger" onclick="openRejectModal('purchase')">🚫 駁回採購單</button>
            </div>
        </div>
    </div>

    <div id="rejectModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('rejectModal')">&times;</span>
            <h2>駁回原因</h2>
            <div class="form-group">
                <label for="rejectReason">請輸入駁回原因:</label>
                <textarea id="rejectReason" rows="4"></textarea>
            </div>
            <button class="btn btn-danger" onclick="confirmReject()">確認駁回</button>
        </div>
    </div>

    <div id="addInventoryItemModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('addInventoryItemModal')">&times;</span>
            <h2>新增庫存品項</h2>
            <div class="form-group">
                <label for="newItemId">品項編號:</label>
                <input type="text" id="newItemId">
            </div>
            <div class="form-group">
                <label for="newItemName">品項名稱:</label>
                <input type="text" id="newItemName">
            </div>
            <div class="form-group">
                <label for="newItemSpec">規格:</label>
                <input type="text" id="newItemSpec">
            </div>
            <div class="form-group">
                <label for="newItemUnit">單位:</label>
                <input type="text" id="newItemUnit">
            </div>
            <div class="form-group">
                <label for="newItemCurrentStock">目前庫存:</label>
                <input type="number" id="newItemCurrentStock" min="0" value="0">
            </div>
            <div class="form-group">
                <label for="newItemSafetyStock">安全庫存:</label>
                <input type="number" id="newItemSafetyStock" min="0" value="0">
            </div>
            <div class="form-group">
                <label for="newItemSupplier">供應商:</label>
                <input type="text" id="newItemSupplier">
            </div>
            <button class="btn btn-success" onclick="addNewInventoryItem()">新增品項</button>
        </div>
    </div>

    <div id="editInventoryItemModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('editInventoryItemModal')">&times;</span>
            <h2>編輯庫存品項</h2>
            <input type="hidden" id="editItemOriginalId">
            <div class="form-group">
                <label for="editItemId">品項編號:</label>
                <input type="text" id="editItemId">
            </div>
            <div class="form-group">
                <label for="editItemName">品項名稱:</label>
                <input type="text" id="editItemName">
            </div>
            <div class="form-group">
                <label for="editItemSpec">規格:</label>
                <input type="text" id="editItemSpec">
            </div>
            <div class="form-group">
                <label for="editItemUnit">單位:</label>
                <input type="text" id="editItemUnit">
            </div>
            <div class="form-group">
                <label for="editItemCurrentStock">目前庫存:</label>
                <input type="number" id="editItemCurrentStock" min="0">
            </div>
            <div class="form-group">
                <label for="editItemSafetyStock">安全庫存:</label>
                <input type="number" id="editItemSafetyStock" min="0">
            </div>
            <div class="form-group">
                <label for="editItemSupplier">供應商:</label>
                <input type="text" id="editItemSupplier">
            </div>
            <button class="btn btn-success" onclick="updateInventoryItem()">儲存變更</button>
        </div>
    </div>

    <div id="addUserModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('addUserModal')">&times;</span>
            <h2>新增使用者</h2>
            <div class="form-group">
                <label for="newUsername">帳號:</label>
                <input type="text" id="newUsername">
            </div>
            <div class="form-group">
                <label for="newPassword">密碼:</label>
                <input type="password" id="newPassword">
            </div>
            <div class="form-group">
                <label for="newFullName">姓名:</label>
                <input type="text" id="newFullName">
            </div>
            <div class="form-group">
                <label for="newUserRole">角色:</label>
                <select id="newUserRole">
                    <option value="applicant">申請人</option>
                    <option value="admin">管理員</option>
                </select>
            </div>
            <button class="btn btn-success" onclick="addNewUser()">新增使用者</button>
        </div>
    </div>

    <div id="editUserModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('editUserModal')">&times;</span>
            <h2>編輯使用者</h2>
            <input type="hidden" id="editUserOriginalUsername">
            <div class="form-group">
                <label for="editUsername">帳號:</label>
                <input type="text" id="editUsername" readonly>
            </div>
            <div class="form-group">
                <label for="editPassword">新密碼 (留空則不更改):</label>
                <input type="password" id="editPassword">
            </div>
            <div class="form-group">
                <label for="editFullName">姓名:</label>
                <input type="text" id="editFullName">
            </div>
            <div class="form-group">
                <label for="editUserRole">角色:</label>
                <select id="editUserRole">
                    <option value="applicant">申請人</option>
                    <option value="admin">管理員</option>
                </select>
            </div>
            <button class="btn btn-success" onclick="updateUser()">儲存變更</button>
        </div>
    </div>

    <div id="previewSelectedItemsModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('previewSelectedItemsModal')">&times;</span>
            <h2>預覽選取的請購項目</h2>
            <table class="table items-table">
                <thead>
                    <tr>
                        <th>請購單號</th>
                        <th>品項名稱</th>
                        <th>規格</th>
                        <th>數量</th>
                        <th>單位</th>
                        <th>預估單價</th>
                        <th>小計</th>
                    </tr>
                </thead>
                <tbody id="previewSelectedItemsTableBody">
                </tbody>
            </table>
            <div style="margin-top: 20px; text-align: right;">
                <strong>總計金額：NT$ <span id="previewTotalAmount">0</span></strong>
            </div>
            <div style="margin-top: 20px;">
                <button class="btn btn-success" onclick="confirmCreatePurchaseFromPreview()">確認並建立採購單</button>
            </div>
        </div>
    </div>

    <script>
        // 您的JavaScript代碼將放在這裡
        // 確保所有功能（登入、頁面切換、數據操作、Excel導出導入等）都在此腳本中
        // 因為是純前端應用，數據將使用 localStorage 進行模擬存儲

        // 模擬數據庫 (使用 localStorage 存儲)
        let users = JSON.parse(localStorage.getItem('users')) || [
            { username: 'admin', password: 'admin', fullname: '系統管理員', role: 'admin' },
            { username: 'user1', password: 'user1', fullname: '內科醫師', role: 'applicant' },
            { username: 'user2', password: 'user2', fullname: '藥劑師', role: 'applicant' }
        ];

        let procurements = JSON.parse(localStorage.getItem('procurements')) || [];
        let purchases = JSON.parse(localStorage.getItem('purchases')) || [];
        let inventory = JSON.parse(localStorage.getItem('inventory')) || [
            { id: 'D001', name: '止痛藥', spec: '500mg/錠', unit: '錠', currentStock: 1000, safetyStock: 200, supplier: '優質藥品供應商' },
            { id: 'M001', name: 'N95口罩', spec: '成人用', unit: '個', currentStock: 500, safetyStock: 100, supplier: '台灣醫材公司' },
            { id: 'D002', name: '抗生素', spec: '注射劑', unit: '劑', currentStock: 300, safetyStock: 50, supplier: '優質藥品供應商' },
            { id: 'M002', name: '點滴架', spec: '不鏽鋼', unit: '組', currentStock: 50, safetyStock: 10, supplier: '康健醫療器材' }
        ];
        let logs = JSON.parse(localStorage.getItem('logs')) || [];

        let currentUser = null;
        let selectedProcurementIdForReject = null; // 用於駁回功能
        let selectedPurchaseIdForReject = null; // 用於駁回功能

        // 保存數據到 localStorage
        function saveData() {
            localStorage.setItem('users', JSON.stringify(users));
            localStorage.setItem('procurements', JSON.stringify(procurements));
            localStorage.setItem('purchases', JSON.stringify(purchases));
            localStorage.setItem('inventory', JSON.stringify(inventory));
            localStorage.setItem('logs', JSON.stringify(logs));
        }

        // 記錄操作日誌
        function addLog(action, description) {
            const now = new Date();
            const log = {
                timestamp: now.toLocaleString('zh-TW', { hour12: false }),
                user: currentUser ? currentUser.fullname : '訪客',
                action: action,
                description: description
            };
            logs.unshift(log); // 最新日誌放在最前面
            saveData();
            renderLogs();
        }

        // 登入功能
        function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            const user = users.find(u => u.username === username && u.password === password);

            if (user) {
                currentUser = user;
                document.getElementById('currentUser').textContent = currentUser.fullname;
                document.getElementById('loginPage').style.display = 'none';
                document.getElementById('mainSystem').style.display = 'block';
                updateNavigationVisibility(); // 根據角色更新導航菜單可見性
                showPage('newProcurement'); // 預設顯示新增請購頁面
                addLog('登入', `使用者 ${currentUser.fullname} 登入系統。`);
            } else {
                alert('帳號或密碼錯誤！');
            }
        }

        // 登出功能
        function logout() {
            addLog('登出', `使用者 ${currentUser.fullname} 登出系統。`);
            currentUser = null;
            document.getElementById('loginPage').style.display = 'flex';
            document.getElementById('mainSystem').style.display = 'none';
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            resetForm(); // 重置請購表單
            resetPurchaseForm(); // 重置採購表單
        }

        // 根據使用者角色更新導航菜單可見性
        function updateNavigationVisibility() {
            const approvalBtn = document.getElementById('approvalBtn');
            const createPurchaseBtn = document.querySelector('.nav-btn[onclick="showPage(\'createPurchase\')"]');
            const inventoryBtn = document.querySelector('.nav-btn[onclick="showPage(\'inventory\')"]');
            const systemAdminBtn = document.querySelector('.nav-btn[onclick="showPage(\'systemAdmin\')"]');

            if (currentUser && currentUser.role === 'admin') {
                approvalBtn.style.display = 'flex'; // 管理員顯示簽核管理
                createPurchaseBtn.style.display = 'flex'; // 管理員顯示建立採購單
                inventoryBtn.style.display = 'flex'; // 管理員顯示庫存管理
                systemAdminBtn.style.display = 'flex'; // 管理員顯示系統管理
            } else {
                approvalBtn.style.display = 'none'; // 申請人隱藏簽核管理
                createPurchaseBtn.style.display = 'none'; // 申請人隱藏建立採購單
                inventoryBtn.style.display = 'none'; // 申請人隱藏庫存管理
                systemAdminBtn.style.display = 'none'; // 申請人隱藏系統管理
            }
            updatePendingCount(); // 更新待簽核數量
        }

        // 頁面切換
        function showPage(pageId) {
            const pages = document.querySelectorAll('.page');
            pages.forEach(page => page.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');

            const navBtns = document.querySelectorAll('.nav-btn');
            navBtns.forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.nav-btn[onclick="showPage('${pageId}')"]`).classList.add('active');

            // 根據不同頁面載入數據
            if (pageId === 'approvalManagement') {
                showApprovalType('procurement'); // 預設顯示請購單簽核
            } else if (pageId === 'approved') {
                showApprovedType('procurement'); // 預設顯示已核准請購單
                updateSelectedCount(); // 更新已核准頁面的選中項目計數
            } else if (pageId === 'rejected') {
                showRejectedType('procurement'); // 預設顯示已駁回請購單
            } else if (pageId === 'inventory') {
                renderInventory();
                updateInventoryStats();
            } else if (pageId === 'systemAdmin') {
                renderUsers();
                renderLogs();
            } else if (pageId === 'newProcurement') {
                generateProcurementNo();
                document.getElementById('applyDate').valueAsDate = new Date();
                resetForm(); // 確保每次進入都是清空的表單
            } else if (pageId === 'createPurchase') {
                generatePurchaseNo();
                document.getElementById('purchaseDate').valueAsDate = new Date();
                resetPurchaseForm(); // 確保每次進入都是清空的表單
            }
            // 關閉所有下拉選單
            document.querySelectorAll('.dropdown-content.show').forEach(dropdown => {
                dropdown.classList.remove('show');
            });
        }

        // 生成請購單號
        function generateProcurementNo() {
            const today = new Date();
            const year = today.getFullYear();
            const month = (today.getMonth() + 1).toString().padStart(2, '0');
            const day = today.getDate().toString().padStart(2, '0');

            // 從 localStorage 獲取當天的最大序號
            const todayProcurements = procurements.filter(p => p.procurementNo.startsWith(`REQ-${year}${month}${day}`));
            let maxSerial = 0;
            if (todayProcurements.length > 0) {
                const serials = todayProcurements.map(p => parseInt(p.procurementNo.slice(-3)));
                maxSerial = Math.max(...serials);
            }
            const nextSerial = (maxSerial + 1).toString().padStart(3, '0');
            document.getElementById('procurementNo').value = `REQ-${year}${month}${day}-${nextSerial}`;
        }

        // 生成採購單號
        function generatePurchaseNo() {
            const today = new Date();
            const year = today.getFullYear();
            const month = (today.getMonth() + 1).toString().padStart(2, '0');
            const day = today.getDate().toString().padStart(2, '0');

            const todayPurchases = purchases.filter(p => p.purchaseNo.startsWith(`PO-${year}${month}${day}`));
            let maxSerial = 0;
            if (todayPurchases.length > 0) {
                const serials = todayPurchases.map(p => parseInt(p.purchaseNo.slice(-3)));
                maxSerial = Math.max(...serials);
            }
            const nextSerial = (maxSerial + 1).toString().padStart(3, '0');
            document.getElementById('purchaseNo').value = `PO-${year}${month}${day}-${nextSerial}`;
        }


        // 請購單項目管理
        function addItem() {
            const tableBody = document.getElementById('itemsTableBody');
            const newRow = tableBody.insertRow();
            newRow.innerHTML = `
                <td><input type="text" placeholder="類別"></td>
                <td><input type="text" placeholder="名稱"></td>
                <td><input type="text" placeholder="規格"></td>
                <td><input type="number" min="1" value="1" onchange="calculateSubtotal(this.parentNode.parentNode)"></td>
                <td><input type="text" placeholder="單位"></td>
                <td><input type="number" min="0" step="0.01" value="0" onchange="calculateSubtotal(this.parentNode.parentNode)"></td>
                <td class="subtotal">0</td>
                <td><button type="button" class="btn btn-danger btn-sm" onclick="deleteItem(this)">刪除</button></td>
            `;
            calculateTotalAmount();
        }

        function deleteItem(button) {
            button.parentNode.parentNode.remove();
            calculateTotalAmount();
        }

        function calculateSubtotal(row) {
            const quantity = parseFloat(row.cells[3].querySelector('input').value) || 0;
            const unitPrice = parseFloat(row.cells[5].querySelector('input').value) || 0;
            const subtotal = quantity * unitPrice;
            row.cells[6].textContent = subtotal.toFixed(2);
            calculateTotalAmount();
        }

        function calculateTotalAmount() {
            let total = 0;
            const tableBody = document.getElementById('itemsTableBody');
            for (let i = 0; i < tableBody.rows.length; i++) {
                total += parseFloat(tableBody.rows[i].cells[6].textContent) || 0;
            }
            document.getElementById('totalAmount').textContent = total.toFixed(2);
        }

        // 提交請購單
        function submitProcurement() {
            const procurementNo = document.getElementById('procurementNo').value;
            const applyDate = document.getElementById('applyDate').value;
            const department = document.getElementById('department').value;
            const applicantName = document.getElementById('applicantName').value;
            const procurementReason = document.getElementById('procurementReason').value;

            if (!procurementNo || !applyDate || !department || !applicantName || !procurementReason) {
                alert('請填寫所有請購單基本資訊！');
                return;
            }

            const items = [];
            const tableBody = document.getElementById('itemsTableBody');
            if (tableBody.rows.length === 0) {
                alert('請至少新增一個請購品項！');
                return;
            }

            for (let i = 0; i < tableBody.rows.length; i++) {
                const row = tableBody.rows[i];
                const item = {
                    category: row.cells[0].querySelector('input').value,
                    name: row.cells[1].querySelector('input').value,
                    spec: row.cells[2].querySelector('input').value,
                    quantity: parseFloat(row.cells[3].querySelector('input').value),
                    unit: row.cells[4].querySelector('input').value,
                    estimatedUnitPrice: parseFloat(row.cells[5].querySelector('input').value),
                    subtotal: parseFloat(row.cells[6].textContent)
                };
                if (!item.category || !item.name || !item.spec || item.quantity <= 0 || !item.unit || item.estimatedUnitPrice < 0) {
                    alert('請檢查所有請購品項的資訊是否填寫完整且正確！');
                    return;
                }
                items.push(item);
            }

            const totalAmount = parseFloat(document.getElementById('totalAmount').textContent);

            const newProcurement = {
                id: procurements.length + 1, // 簡單的ID生成
                procurementNo: procurementNo,
                applyDate: applyDate,
                department: department,
                applicantName: applicantName,
                procurementReason: procurementReason,
                items: items,
                totalAmount: totalAmount,
                status: 'pending', // 初始狀態為待簽核
                approver: null,
                approvalTime: null,
                rejectReason: null
            };

            procurements.unshift(newProcurement); // 新的請購單放在最前面
            saveData();
            alert('請購單提交成功，等待簽核！');
            addLog('提交請購單', `提交請購單號: ${procurementNo}`);
            resetForm();
            updatePendingCount();
        }

        // 重置請購表單
        function resetForm() {
            document.getElementById('procurementForm').reset();
            document.getElementById('itemsTableBody').innerHTML = '';
            document.getElementById('totalAmount').textContent = '0';
            generateProcurementNo();
            document.getElementById('applyDate').valueAsDate = new Date();
        }

        // 更新待簽核數量
        function updatePendingCount() {
            const pendingProcurements = procurements.filter(p => p.status === 'pending');
            const pendingPurchases = purchases.filter(p => p.status === 'pending');
            const count = pendingProcurements.length + pendingPurchases.length;
            const badge = document.getElementById('pendingCount');
            if (count > 0 && currentUser && currentUser.role === 'admin') {
                badge.textContent = count;
                badge.style.display = 'flex';
            } else {
                badge.style.display = 'none';
            }
        }

        // 顯示簽核類型
        function showApprovalType(type) {
            document.getElementById('procurementApproval').style.display = 'none';
            document.getElementById('purchaseApproval').style.display = 'none';
            if (type === 'procurement') {
                document.getElementById('procurementApproval').style.display = 'block';
                renderPendingProcurements();
            } else if (type === 'purchase') {
                document.getElementById('purchaseApproval').style.display = 'block';
                renderPendingPurchases();
            }
        }

        // 渲染待簽核請購單
        function renderPendingProcurements() {
            const tableBody = document.getElementById('pendingProcurementTable');
            tableBody.innerHTML = '';
            const pending = procurements.filter(p => p.status === 'pending');
            if (pending.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">目前沒有待審核的請購單。</td></tr>';
                return;
            }

            pending.forEach(p => {
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td>${p.procurementNo}</td>
                    <td>${p.applyDate}</td>
                    <td>${p.department}</td>
                    <td>${p.applicantName}</td>
                    <td><span class="status-badge status-pending">待簽核</span></td>
                    <td>
                        <button class="btn btn-primary" onclick="viewProcurementDetail('${p.procurementNo}')">查看詳情</button>
                    </td>
                `;
            });
        }

        // 渲染待簽核採購單
        function renderPendingPurchases() {
            const tableBody = document.getElementById('pendingPurchaseTable');
            tableBody.innerHTML = '';
            const pending = purchases.filter(p => p.status === 'pending');
            if (pending.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">目前沒有待審核的採購單。</td></tr>';
                return;
            }

            pending.forEach(p => {
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td>${p.purchaseNo}</td>
                    <td>${p.purchaseDate}</td>
                    <td>${p.supplier}</td>
                    <td>NT$ ${p.totalAmount.toFixed(2)}</td>
                    <td><span class="status-badge status-pending">待簽核</span></td>
                    <td>
                        <button class="btn btn-primary" onclick="viewPurchaseDetail('${p.purchaseNo}')">查看詳情</button>
                    </td>
                `;
            });
        }

        // 查看請購單詳情
        function viewProcurementDetail(procurementNo) {
            const procurement = procurements.find(p => p.procurementNo === procurementNo);
            if (!procurement) return;

            document.getElementById('modalProcurementNo').textContent = procurement.procurementNo;
            document.getElementById('modalApplyDate').textContent = procurement.applyDate;
            document.getElementById('modalDepartment').textContent = procurement.department;
            document.getElementById('modalApplicantName').textContent = procurement.applicantName;
            document.getElementById('modalProcurementReason').textContent = procurement.procurementReason;

            const itemsBody = document.getElementById('modalItemsTableBody');
            itemsBody.innerHTML = '';
            procurement.items.forEach(item => {
                const row = itemsBody.insertRow();
                row.innerHTML = `
                    <td>${item.category}</td>
                    <td>${item.name}</td>
                    <td>${item.spec}</td>
                    <td>${item.quantity}</td>
                    <td>${item.unit}</td>
                    <td>${item.estimatedUnitPrice.toFixed(2)}</td>
                    <td>${item.subtotal.toFixed(2)}</td>
                `;
            });
            document.getElementById('modalTotalAmount').textContent = procurement.totalAmount.toFixed(2);

            // 如果是管理員且請購單待簽核，顯示簽核按鈕
            const approvalActions = document.getElementById('approvalActions');
            if (currentUser && currentUser.role === 'admin' && procurement.status === 'pending') {
                approvalActions.style.display = 'block';
            } else {
                approvalActions.style.display = 'none';
            }

            selectedProcurementIdForReject = procurementNo; // 保存當前查看的請購單號，用於駁回
            document.getElementById('procurementDetailModal').style.display = 'block';
        }

        // 查看採購單詳情
        function viewPurchaseDetail(purchaseNo) {
            const purchase = purchases.find(p => p.purchaseNo === purchaseNo);
            if (!purchase) return;

            document.getElementById('modalPurchaseNo').textContent = purchase.purchaseNo;
            document.getElementById('modalPurchaseDate').textContent = purchase.purchaseDate;
            document.getElementById('modalSupplier').textContent = purchase.supplier;
            document.getElementById('modalContactPerson').textContent = purchase.contactPerson;
            document.getElementById('modalPurchaseNote').textContent = purchase.purchaseNote;

            const itemsBody = document.getElementById('modalPurchaseItemsTableBody');
            itemsBody.innerHTML = '';
            purchase.items.forEach(item => {
                const row = itemsBody.insertRow();
                row.innerHTML = `
                    <td>${item.id || ''}</td>
                    <td>${item.name}</td>
                    <td>${item.spec}</td>
                    <td>${item.quantity}</td>
                    <td>${item.unit}</td>
                    <td>${item.unitPrice.toFixed(2)}</td>
                    <td>${item.subtotal.toFixed(2)}</td>
                `;
            });
            document.getElementById('modalPurchaseTotalAmount').textContent = purchase.totalAmount.toFixed(2);

            // 如果是管理員且採購單待簽核，顯示簽核按鈕
            const purchaseApprovalActions = document.getElementById('purchaseApprovalActions');
            if (currentUser && currentUser.role === 'admin' && purchase.status === 'pending') {
                purchaseApprovalActions.style.display = 'block';
            } else {
                purchaseApprovalActions.style.display = 'none';
            }

            selectedPurchaseIdForReject = purchaseNo; // 保存當前查看的採購單號，用於駁回
            document.getElementById('purchaseDetailModal').style.display = 'block';
        }


        // 核准請購單
        function approveProcurement() {
            const procurementNo = document.getElementById('modalProcurementNo').textContent;
            const procurementIndex = procurements.findIndex(p => p.procurementNo === procurementNo);

            if (procurementIndex !== -1) {
                procurements[procurementIndex].status = 'approved';
                procurements[procurementIndex].approver = currentUser.fullname;
                procurements[procurementIndex].approvalTime = new Date().toLocaleString('zh-TW', { hour12: false });
                saveData();
                alert(`請購單 ${procurementNo} 已核准！`);
                addLog('核准請購單', `核准請購單號: ${procurementNo}`);
                closeModal('procurementDetailModal');
                renderPendingProcurements(); // 刷新待簽核列表
                updatePendingCount();
                showApprovedType('procurement'); // 刷新已核准列表
            }
        }

        // 核准採購單
        function approvePurchase() {
            const purchaseNo = document.getElementById('modalPurchaseNo').textContent;
            const purchaseIndex = purchases.findIndex(p => p.purchaseNo === purchaseNo);

            if (purchaseIndex !== -1) {
                purchases[purchaseIndex].status = 'approved';
                purchases[purchaseIndex].approver = currentUser.fullname;
                purchases[purchaseIndex].approvalTime = new Date().toLocaleString('zh-TW', { hour12: false });
                saveData();
                alert(`採購單 ${purchaseNo} 已核准！`);
                addLog('核准採購單', `核准採購單號: ${purchaseNo}`);
                closeModal('purchaseDetailModal');
                renderPendingPurchases(); // 刷新待簽核列表
                updatePendingCount();
                showApprovedType('purchase'); // 刷新已核准列表
            }
        }

        // 開啟駁回模態框
        function openRejectModal(type) {
            document.getElementById('rejectReason').value = ''; // 清空原因
            document.getElementById('rejectModal').dataset.type = type; // 儲存駁回類型
            closeModal('procurementDetailModal'); // 關閉請購單詳情
            closeModal('purchaseDetailModal'); // 關閉採購單詳情
            document.getElementById('rejectModal').style.display = 'block';
        }

        // 確認駁回
        function confirmReject() {
            const rejectReason = document.getElementById('rejectReason').value;
            const rejectType = document.getElementById('rejectModal').dataset.type;
            const now = new Date().toLocaleString('zh-TW', { hour12: false });

            if (!rejectReason) {
                alert('請輸入駁回原因！');
                return;
            }

            if (rejectType === 'procurement') {
                const procurementIndex = procurements.findIndex(p => p.procurementNo === selectedProcurementIdForReject);
                if (procurementIndex !== -1) {
                    procurements[procurementIndex].status = 'rejected';
                    procurements[procurementIndex].approver = currentUser.fullname; // 記錄駁回人
                    procurements[procurementIndex].approvalTime = now; // 記錄駁回時間
                    procurements[procurementIndex].rejectReason = rejectReason;
                    saveData();
                    alert(`請購單 ${selectedProcurementIdForReject} 已駁回！`);
                    addLog('駁回請購單', `駁回請購單號: ${selectedProcurementIdForReject}，原因: ${rejectReason}`);
                    renderPendingProcurements(); // 刷新待簽核列表
                    updatePendingCount();
                    showRejectedType('procurement'); // 刷新已駁回列表
                }
            } else if (rejectType === 'purchase') {
                const purchaseIndex = purchases.findIndex(p => p.purchaseNo === selectedPurchaseIdForReject);
                if (purchaseIndex !== -1) {
                    purchases[purchaseIndex].status = 'rejected';
                    purchases[purchaseIndex].approver = currentUser.fullname; // 記錄駁回人
                    purchases[purchaseIndex].approvalTime = now; // 記錄駁回時間
                    purchases[purchaseIndex].rejectReason = rejectReason;
                    saveData();
                    alert(`採購單 ${selectedPurchaseIdForReject} 已駁回！`);
                    addLog('駁回採購單', `駁回採購單號: ${selectedPurchaseIdForReject}，原因: ${rejectReason}`);
                    renderPendingPurchases(); // 刷新待簽核列表
                    updatePendingCount();
                    showRejectedType('purchase'); // 刷新已駁回列表
                }
            }
            closeModal('rejectModal');
        }

        // 關閉模態框
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // 顯示已核准類型
        function showApprovedType(type) {
            document.getElementById('approvedProcurementSection').style.display = 'none';
            document.getElementById('approvedPurchaseSection').style.display = 'none';
            if (type === 'procurement') {
                document.getElementById('approvedProcurementSection').style.display = 'block';
                renderApprovedProcurements();
            } else if (type === 'purchase') {
                document.getElementById('approvedPurchaseSection').style.display = 'block';
                renderApprovedPurchases();
            }
            // 重置全選狀態和計數
            document.getElementById('selectAllCheckbox').checked = false;
            updateSelectedCount();
        }

        // 渲染已核准請購單
        function renderApprovedProcurements() {
            const tableBody = document.getElementById('approvedProcurementTable');
            tableBody.innerHTML = '';
            const approved = procurements.filter(p => p.status === 'approved');
            if (approved.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="9" style="text-align: center;">目前沒有已核准的請購單。</td></tr>';
                return;
            }

            approved.forEach(p => {
                const row = tableBody.insertRow();
                row.dataset.procurementNo = p.procurementNo; // 用於後續選擇
                row.innerHTML = `
                    <td><input type="checkbox" class="approved-checkbox" onchange="updateSelectedCount()"></td>
                    <td>${p.procurementNo}</td>
                    <td>${p.applyDate}</td>
                    <td>${p.department}</td>
                    <td>${p.applicantName}</td>
                    <td>NT$ ${p.totalAmount.toFixed(2)}</td>
                    <td>${p.approver || 'N/A'}</td>
                    <td>${p.approvalTime || 'N/A'}</td>
                    <td>
                        <button class="btn btn-primary" onclick="viewProcurementDetail('${p.procurementNo}')">查看詳情</button>
                        <button class="btn btn-success" onclick="downloadProcurementExcel('${p.procurementNo}')">下載Excel</button>
                    </td>
                `;
            });
        }

        // 渲染已核准採購單
        function renderApprovedPurchases() {
            const tableBody = document.getElementById('approvedPurchaseTable');
            tableBody.innerHTML = '';
            const approved = purchases.filter(p => p.status === 'approved');
            if (approved.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="8" style="text-align: center;">目前沒有已核准的採購單。</td></tr>';
                return;
            }

            approved.forEach(p => {
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td>${p.purchaseNo}</td>
                    <td>${p.purchaseDate}</td>
                    <td>${p.supplier}</td>
                    <td>NT$ ${p.totalAmount.toFixed(2)}</td>
                    <td>${p.approver || 'N/A'}</td>
                    <td>${p.approvalTime || 'N/A'}</td>
                    <td>
                        <button class="btn btn-primary" onclick="viewPurchaseDetail('${p.purchaseNo}')">查看詳情</button>
                        <button class="btn btn-success" onclick="downloadPurchaseExcel('${p.purchaseNo}')">下載Excel</button>
                    </td>
                `;
            });
        }

        // 下載單個請購單為Excel
        function downloadProcurementExcel(procurementNo) {
            const procurement = procurements.find(p => p.procurementNo === procurementNo);
            if (!procurement) {
                alert('找不到該請購單！');
                return;
            }

            const ws_data = [
                ['請購單號:', procurement.procurementNo],
                ['申請日期:', procurement.applyDate],
                ['申請部門:', procurement.department],
                ['申請人:', procurement.applicantName],
                ['請購事由:', procurement.procurementReason],
                [], // 空行
                ['請購品項'],
                ['類別', '名稱', '規格', '數量', '單位', '預估單價', '小計']
            ];

            procurement.items.forEach(item => {
                ws_data.push([
                    item.category,
                    item.name,
                    item.spec,
                    item.quantity,
                    item.unit,
                    item.estimatedUnitPrice,
                    item.subtotal
                ]);
            });

            ws_data.push([]); // 空行
            ws_data.push(['總金額:', '', '', '', '', '', procurement.totalAmount]);
            ws_data.push([]);
            ws_data.push(['核准狀態:', procurement.status]);
            if (procurement.approver) {
                ws_data.push(['核准人:', procurement.approver]);
                ws_data.push(['核准時間:', procurement.approvalTime]);
            }
            if (procurement.rejectReason) {
                ws_data.push(['駁回原因:', procurement.rejectReason]);
            }

            const ws = XLSX.utils.aoa_to_sheet(ws_data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "請購單詳情");
            XLSX.writeFile(wb, `${procurement.procurementNo}.xlsx`);
            addLog('下載請購單Excel', `下載請購單號: ${procurementNo} 的Excel檔案。`);
        }

        // 下載單個採購單為Excel
        function downloadPurchaseExcel(purchaseNo) {
            const purchase = purchases.find(p => p.purchaseNo === purchaseNo);
            if (!purchase) {
                alert('找不到該採購單！');
                return;
            }

            const ws_data = [
                ['採購單號:', purchase.purchaseNo],
                ['採購日期:', purchase.purchaseDate],
                ['供應商:', purchase.supplier],
                ['聯絡人:', purchase.contactPerson],
                ['備註:', purchase.purchaseNote],
                [], // 空行
                ['採購品項'],
                ['品項編號', '品項名稱', '規格', '數量', '單位', '單價', '小計']
            ];

            purchase.items.forEach(item => {
                ws_data.push([
                    item.id || '',
                    item.name,
                    item.spec,
                    item.quantity,
                    item.unit,
                    item.unitPrice,
                    item.subtotal
                ]);
            });

            ws_data.push([]); // 空行
            ws_data.push(['總金額:', '', '', '', '', '', purchase.totalAmount]);
            ws_data.push([]);
            ws_data.push(['核准狀態:', purchase.status]);
            if (purchase.approver) {
                ws_data.push(['核准人:', purchase.approver]);
                ws_data.push(['核准時間:', purchase.approvalTime]);
            }
            if (purchase.rejectReason) {
                ws_data.push(['駁回原因:', purchase.rejectReason]);
            }

            const ws = XLSX.utils.aoa_to_sheet(ws_data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "採購單詳情");
            XLSX.writeFile(wb, `${purchase.purchaseNo}.xlsx`);
            addLog('下載採購單Excel', `下載採購單號: ${purchaseNo} 的Excel檔案。`);
        }

        // 下載所有已核准請購單為一個Excel
        function downloadAllApproved() {
            const approvedProcurements = procurements.filter(p => p.status === 'approved');
            if (approvedProcurements.length === 0) {
                alert('目前沒有已核准的請購單可供下載！');
                return;
            }

            const wb = XLSX.utils.book_new();

            approvedProcurements.forEach(procurement => {
                const ws_data = [
                    ['請購單號:', procurement.procurementNo],
                    ['申請日期:', procurement.applyDate],
                    ['申請部門:', procurement.department],
                    ['申請人:', procurement.applicantName],
                    ['請購事由:', procurement.procurementReason],
                    [], // 空行
                    ['請購品項'],
                    ['類別', '名稱', '規格', '數量', '單位', '預估單價', '小計']
                ];

                procurement.items.forEach(item => {
                    ws_data.push([
                        item.category,
                        item.name,
                        item.spec,
                        item.quantity,
                        item.unit,
                        item.estimatedUnitPrice,
                        item.subtotal
                    ]);
                });

                ws_data.push([]); // 空行
                ws_data.push(['總金額:', '', '', '', '', '', procurement.totalAmount]);
                ws_data.push([]);
                ws_data.push(['核准狀態:', procurement.status]);
                if (procurement.approver) {
                    ws_data.push(['核准人:', procurement.approver]);
                    ws_data.push(['核准時間:', procurement.approvalTime]);
                }

                const ws = XLSX.utils.aoa_to_sheet(ws_data);
                XLSX.utils.book_append_sheet(wb, ws, procurement.procurementNo); // 以請購單號作為工作表名稱
            });

            XLSX.writeFile(wb, "所有已核准請購單.xlsx");
            addLog('下載所有已核准請購單', '下載了所有已核准請購單的Excel檔案。');
        }


        // 顯示已駁回類型
        function showRejectedType(type) {
            document.getElementById('rejectedProcurementSection').style.display = 'none';
            document.getElementById('rejectedPurchaseSection').style.display = 'none';
            if (type === 'procurement') {
                document.getElementById('rejectedProcurementSection').style.display = 'block';
                renderRejectedProcurements();
            } else if (type === 'purchase') {
                document.getElementById('rejectedPurchaseSection').style.display = 'block';
                renderRejectedPurchases();
            }
        }

        // 渲染已駁回請購單
        function renderRejectedProcurements() {
            const tableBody = document.getElementById('rejectedProcurementTable');
            tableBody.innerHTML = '';
            const rejected = procurements.filter(p => p.status === 'rejected');
            if (rejected.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="7" style="text-align: center;">目前沒有已駁回的請購單。</td></tr>';
                return;
            }

            rejected.forEach(p => {
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td>${p.procurementNo}</td>
                    <td>${p.applyDate}</td>
                    <td>${p.department}</td>
                    <td>${p.applicantName}</td>
                    <td>${p.approver || 'N/A'}</td>
                    <td>${p.approvalTime || 'N/A'}</td>
                    <td>${p.rejectReason || '無'}</td>
                `;
            });
        }

        // 渲染已駁回採購單
        function renderRejectedPurchases() {
            const tableBody = document.getElementById('rejectedPurchaseTable');
            tableBody.innerHTML = '';
            const rejected = purchases.filter(p => p.status === 'rejected');
            if (rejected.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="8" style="text-align: center;">目前沒有已駁回的採購單。</td></tr>';
                return;
            }

            rejected.forEach(p => {
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td>${p.purchaseNo}</td>
                    <td>${p.purchaseDate}</td>
                    <td>${p.supplier}</td>
                    <td>NT$ ${p.totalAmount.toFixed(2)}</td>
                    <td>${p.approver || 'N/A'}</td>
                    <td>${p.approvalTime || 'N/A'}</td>
                    <td>${p.rejectReason || '無'}</td>
                `;
            });
        }


        // 採購單項目管理
        function addPurchaseItem() {
            const tableBody = document.getElementById('purchaseItemsTableBody');
            const newRow = tableBody.insertRow();
            newRow.innerHTML = `
                <td><input type="text" placeholder="品項編號"></td>
                <td><input type="text" placeholder="品項名稱"></td>
                <td><input type="text" placeholder="規格"></td>
                <td><input type="number" min="1" value="1" onchange="calculatePurchaseSubtotal(this.parentNode.parentNode)"></td>
                <td><input type="text" placeholder="單位"></td>
                <td><input type="number" min="0" step="0.01" value="0" onchange="calculatePurchaseSubtotal(this.parentNode.parentNode)"></td>
                <td class="subtotal">0</td>
                <td><button type="button" class="btn btn-danger btn-sm" onclick="deletePurchaseItem(this)">刪除</button></td>
            `;
            calculatePurchaseTotalAmount();
        }

        function deletePurchaseItem(button) {
            button.parentNode.parentNode.remove();
            calculatePurchaseTotalAmount();
        }

        function calculatePurchaseSubtotal(row) {
            const quantity = parseFloat(row.cells[3].querySelector('input').value) || 0;
            const unitPrice = parseFloat(row.cells[5].querySelector('input').value) || 0;
            const subtotal = quantity * unitPrice;
            row.cells[6].textContent = subtotal.toFixed(2);
            calculatePurchaseTotalAmount();
        }

        function calculatePurchaseTotalAmount() {
            let total = 0;
            const tableBody = document.getElementById('purchaseItemsTableBody');
            for (let i = 0; i < tableBody.rows.length; i++) {
                total += parseFloat(tableBody.rows[i].cells[6].textContent) || 0;
            }
            document.getElementById('purchaseTotalAmount').textContent = total.toFixed(2);
        }

        // 提交採購單
        function submitPurchase() {
            const purchaseNo = document.getElementById('purchaseNo').value;
            const purchaseDate = document.getElementById('purchaseDate').value;
            const supplier = document.getElementById('supplier').value;
            const contactPerson = document.getElementById('contactPerson').value;
            const purchaseNote = document.getElementById('purchaseNote').value;

            if (!purchaseNo || !purchaseDate || !supplier || !contactPerson) {
                alert('請填寫所有採購單基本資訊！');
                return;
            }

            const items = [];
            const tableBody = document.getElementById('purchaseItemsTableBody');
            if (tableBody.rows.length === 0) {
                alert('請至少新增一個採購品項！');
                return;
            }

            for (let i = 0; i < tableBody.rows.length; i++) {
                const row = tableBody.rows[i];
                const item = {
                    id: row.cells[0].querySelector('input').value,
                    name: row.cells[1].querySelector('input').value,
                    spec: row.cells[2].querySelector('input').value,
                    quantity: parseFloat(row.cells[3].querySelector('input').value),
                    unit: row.cells[4].querySelector('input').value,
                    unitPrice: parseFloat(row.cells[5].querySelector('input').value),
                    subtotal: parseFloat(row.cells[6].textContent)
                };
                if (!item.name || !item.spec || item.quantity <= 0 || !item.unit || item.unitPrice < 0) {
                    alert('請檢查所有採購品項的資訊是否填寫完整且正確！');
                    return;
                }
                items.push(item);
            }

            const totalAmount = parseFloat(document.getElementById('purchaseTotalAmount').textContent);

            const newPurchase = {
                id: purchases.length + 1,
                purchaseNo: purchaseNo,
                purchaseDate: purchaseDate,
                supplier: supplier,
                contactPerson: contactPerson,
                purchaseNote: purchaseNote,
                items: items,
                totalAmount: totalAmount,
                status: 'pending', // 初始狀態為待簽核
                approver: null,
                approvalTime: null,
                rejectReason: null
            };

            purchases.unshift(newPurchase);
            saveData();
            alert('採購單提交成功，等待簽核！');
            addLog('提交採購單', `提交採購單號: ${purchaseNo}`);
            resetPurchaseForm();
            updatePendingCount();
        }

        // 重置採購表單
        function resetPurchaseForm() {
            document.getElementById('purchaseForm').reset();
            document.getElementById('purchaseItemsTableBody').innerHTML = '';
            document.getElementById('purchaseTotalAmount').textContent = '0';
            generatePurchaseNo();
            document.getElementById('purchaseDate').valueAsDate = new Date();
        }

        // 庫存管理功能

        // 渲染庫存列表
        function renderInventory() {
            const tableBody = document.getElementById('inventoryTableBody');
            tableBody.innerHTML = '';
            const searchTerm = document.getElementById('inventorySearch').value.toLowerCase();

            const filteredInventory = inventory.filter(item =>
                item.name.toLowerCase().includes(searchTerm) ||
                item.id.toLowerCase().includes(searchTerm)
            );

            if (filteredInventory.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="8" style="text-align: center;">沒有符合條件的庫存品項。</td></tr>';
                return;
            }

            filteredInventory.forEach(item => {
                const row = tableBody.insertRow();
                let stockStatusClass = '';
                if (item.currentStock <= item.safetyStock) {
                    stockStatusClass = 'status-pending'; // 用黃色表示低庫存
                }
                if (item.currentStock === 0) {
                    stockStatusClass = 'status-rejected'; // 用紅色表示缺貨
                }

                row.innerHTML = `
                    <td>${item.id}</td>
                    <td>${item.name}</td>
                    <td>${item.spec}</td>
                    <td>${item.unit}</td>
                    <td><span class="status-badge ${stockStatusClass}">${item.currentStock}</span></td>
                    <td>${item.safetyStock}</td>
                    <td>${item.supplier}</td>
                    <td>
                        <button class="btn btn-primary btn-sm" onclick="openEditInventoryItemModal('${item.id}')">編輯</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteInventoryItem('${item.id}')">刪除</button>
                    </td>
                `;
            });
        }

        // 過濾庫存列表
        function filterInventory() {
            renderInventory();
        }

        // 更新庫存統計數據
        function updateInventoryStats() {
            let lowStock = 0;
            let outOfStock = 0;
            inventory.forEach(item => {
                if (item.currentStock === 0) {
                    outOfStock++;
                } else if (item.currentStock <= item.safetyStock) {
                    lowStock++;
                }
            });
            document.getElementById('lowStockCount').textContent = lowStock;
            document.getElementById('outOfStockCount').textContent = outOfStock;
            document.getElementById('totalItemsCount').textContent = inventory.length;
        }

        // 開啟新增庫存品項模態框
        function openAddItemModal() {
            document.getElementById('addInventoryItemModal').style.display = 'block';
            document.getElementById('newItemId').value = '';
            document.getElementById('newItemName').value = '';
            document.getElementById('newItemSpec').value = '';
            document.getElementById('newItemUnit').value = '';
            document.getElementById('newItemCurrentStock').value = '0';
            document.getElementById('newItemSafetyStock').value = '0';
            document.getElementById('newItemSupplier').value = '';
        }

        // 新增庫存品項
        function addNewInventoryItem() {
            const newItemId = document.getElementById('newItemId').value.trim();
            const newItemName = document.getElementById('newItemName').value.trim();
            const newItemSpec = document.getElementById('newItemSpec').value.trim();
            const newItemUnit = document.getElementById('newItemUnit').value.trim();
            const newItemCurrentStock = parseInt(document.getElementById('newItemCurrentStock').value);
            const newItemSafetyStock = parseInt(document.getElementById('newItemSafetyStock').value);
            const newItemSupplier = document.getElementById('newItemSupplier').value.trim();

            if (!newItemId || !newItemName || !newItemSpec || !newItemUnit || isNaN(newItemCurrentStock) || isNaN(newItemSafetyStock) || !newItemSupplier) {
                alert('請填寫所有庫存品項資訊！');
                return;
            }
            if (inventory.some(item => item.id === newItemId)) {
                alert('品項編號已存在，請使用不同的編號！');
                return;
            }

            inventory.unshift({ // 新增到最前面
                id: newItemId,
                name: newItemName,
                spec: newItemSpec,
                unit: newItemUnit,
                currentStock: newItemCurrentStock,
                safetyStock: newItemSafetyStock,
                supplier: newItemSupplier
            });
            saveData();
            alert('新庫存品項新增成功！');
            addLog('新增庫存品項', `新增品項: ${newItemName} (編號: ${newItemId})`);
            renderInventory();
            updateInventoryStats();
            closeModal('addInventoryItemModal');
        }

        // 開啟編輯庫存品項模態框
        function openEditInventoryItemModal(itemId) {
            const item = inventory.find(i => i.id === itemId);
            if (!item) return;

            document.getElementById('editItemOriginalId').value = item.id; // 保存原始ID
            document.getElementById('editItemId').value = item.id;
            document.getElementById('editItemName').value = item.name;
            document.getElementById('editItemSpec').value = item.spec;
            document.getElementById('editItemUnit').value = item.unit;
            document.getElementById('editItemCurrentStock').value = item.currentStock;
            document.getElementById('editItemSafetyStock').value = item.safetyStock;
            document.getElementById('editItemSupplier').value = item.supplier;
            document.getElementById('editInventoryItemModal').style.display = 'block';
        }

        // 更新庫存品項
        function updateInventoryItem() {
            const originalId = document.getElementById('editItemOriginalId').value;
            const editItemId = document.getElementById('editItemId').value.trim();
            const editItemName = document.getElementById('editItemName').value.trim();
            const editItemSpec = document.getElementById('editItemSpec').value.trim();
            const editItemUnit = document.getElementById('editItemUnit').value.trim();
            const editItemCurrentStock = parseInt(document.getElementById('editItemCurrentStock').value);
            const editItemSafetyStock = parseInt(document.getElementById('editItemSafetyStock').value);
            const editItemSupplier = document.getElementById('editItemSupplier').value.trim();

            if (!editItemId || !editItemName || !editItemSpec || !editItemUnit || isNaN(editItemCurrentStock) || isNaN(editItemSafetyStock) || !editItemSupplier) {
                alert('請填寫所有庫存品項資訊！');
                return;
            }

            const itemIndex = inventory.findIndex(item => item.id === originalId);
            if (itemIndex !== -1) {
                inventory[itemIndex] = {
                    id: editItemId,
                    name: editItemName,
                    spec: editItemSpec,
                    unit: editItemUnit,
                    currentStock: editItemCurrentStock,
                    safetyStock: editItemSafetyStock,
                    supplier: editItemSupplier
                };
                saveData();
                alert('庫存品項更新成功！');
                addLog('更新庫存品項', `更新品項: ${editItemName} (編號: ${editItemId})`);
                renderInventory();
                updateInventoryStats();
                closeModal('editInventoryItemModal');
            }
        }

        // 刪除庫存品項
        function deleteInventoryItem(itemId) {
            if (confirm(`確定要刪除品項編號 ${itemId} 嗎？此操作不可逆！`)) {
                inventory = inventory.filter(item => item.id !== itemId);
                saveData();
                alert('庫存品項已刪除！');
                addLog('刪除庫存品項', `刪除品項編號: ${itemId}`);
                renderInventory();
                updateInventoryStats();
            }
        }

        // 處理Excel上傳
        function handleExcelUpload(event) {
            const file = event.target.files[0];
            const fileNameSpan = document.getElementById('uploadFileName');
            const uploadStatusDiv = document.getElementById('uploadStatus');

            if (!file) {
                fileNameSpan.textContent = '未選擇檔案';
                uploadStatusDiv.style.display = 'none';
                return;
            }

            fileNameSpan.textContent = `已選擇檔案: ${file.name}`;
            uploadStatusDiv.style.display = 'block';
            uploadStatusDiv.className = 'upload-status status-info';
            uploadStatusDiv.textContent = '正在讀取檔案...';

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const json = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                    // 假設Excel第一行為標題，從第二行開始讀取數據
                    if (json.length < 2) {
                        uploadStatusDiv.className = 'upload-status status-error';
                        uploadStatusDiv.textContent = 'Excel檔案內容不足，請確保包含標題和數據。';
                        return;
                    }

                    // 檢查標題列，確保格式正確
                    const headers = json[0].map(h => typeof h === 'string' ? h.trim() : '');
                    const expectedHeaders = ['品項編號', '品項名稱', '規格', '單位', '目前庫存', '安全庫存', '供應商'];

                    const missingHeaders = expectedHeaders.filter(header => !headers.includes(header));
                    if (missingHeaders.length > 0) {
                        uploadStatusDiv.className = 'upload-status status-error';
                        uploadStatusDiv.textContent = `Excel標題不符。缺少：${missingHeaders.join(', ')}。請確保標題列包含：${expectedHeaders.join(', ')}。`;
                        return;
                    }

                    const newInventoryData = [];
                    for (let i = 1; i < json.length; i++) {
                        const rowData = json[i];
                        if (rowData.length >= expectedHeaders.length && rowData.some(cell => cell !== undefined && cell !== '')) { // 確保行有數據
                            const item = {};
                            expectedHeaders.forEach((header, index) => {
                                const headerIndex = headers.indexOf(header);
                                if (headerIndex !== -1) {
                                    item[convertHeaderToKey(header)] = rowData[headerIndex];
                                }
                            });
                            newInventoryData.push({
                                id: String(item.id || ''),
                                name: String(item.name || ''),
                                spec: String(item.spec || ''),
                                unit: String(item.unit || ''),
                                currentStock: Number(item.currentStock) || 0,
                                safetyStock: Number(item.safetyStock) || 0,
                                supplier: String(item.supplier || '')
                            });
                        }
                    }

                    // 合併或替換現有庫存
                    // 這裡選擇替換模式：新上傳的 Excel 將完全取代現有庫存
                    inventory = newInventoryData;
                    saveData();
                    renderInventory();
                    updateInventoryStats();
                    uploadStatusDiv.className = 'upload-status status-success';
                    uploadStatusDiv.textContent = `檔案 "${file.name}" 上傳成功，已更新庫存數據。共載入 ${newInventoryData.length} 條記錄。`;
                    addLog('上傳庫存Excel', `從檔案 "${file.name}" 更新了庫存數據。`);

                } catch (error) {
                    console.error('Error processing Excel file:', error);
                    uploadStatusDiv.className = 'upload-status status-error';
                    uploadStatusDiv.textContent = `處理檔案時發生錯誤: ${error.message}。請確認檔案格式是否正確。`;
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function convertHeaderToKey(header) {
            switch (header) {
                case '品項編號': return 'id';
                case '品項名稱': return 'name';
                case '規格': return 'spec';
                case '單位': return 'unit';
                case '目前庫存': return 'currentStock';
                case '安全庫存': return 'safetyStock';
                case '供應商': return 'supplier';
                default: return header;
            }
        }

        // 下載庫存為Excel
        function downloadInventoryExcel() {
            if (inventory.length === 0) {
                alert('目前沒有庫存數據可供下載！');
                return;
            }

            const ws_data = [
                ['品項編號', '品項名稱', '規格', '單位', '目前庫存', '安全庫存', '供應商']
            ];

            inventory.forEach(item => {
                ws_data.push([
                    item.id,
                    item.name,
                    item.spec,
                    item.unit,
                    item.currentStock,
                    item.safetyStock,
                    item.supplier
                ]);
            });

            const ws = XLSX.utils.aoa_to_sheet(ws_data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "庫存清單");
            XLSX.writeFile(wb, "庫存清單.xlsx");
            addLog('下載庫存Excel', '下載了庫存清單的Excel檔案。');
        }

        // 系統管理 - 使用者管理

        // 渲染使用者列表
        function renderUsers() {
            const tableBody = document.getElementById('userTableBody');
            tableBody.innerHTML = '';
            users.forEach(user => {
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td>${user.username}</td>
                    <td>${user.fullname}</td>
                    <td>${user.role === 'admin' ? '管理員' : '申請人'}</td>
                    <td>
                        <button class="btn btn-primary btn-sm" onclick="openEditUserModal('${user.username}')">編輯</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteUser('${user.username}')">刪除</button>
                    </td>
                `;
            });
        }

        // 開啟新增使用者模態框
        function openAddUserModal() {
            document.getElementById('addUserModal').style.display = 'block';
            document.getElementById('newUsername').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('newFullName').value = '';
            document.getElementById('newUserRole').value = 'applicant';
        }

        // 新增使用者
        function addNewUser() {
            const newUsername = document.getElementById('newUsername').value.trim();
            const newPassword = document.getElementById('newPassword').value.trim();
            const newFullName = document.getElementById('newFullName').value.trim();
            const newUserRole = document.getElementById('newUserRole').value;

            if (!newUsername || !newPassword || !newFullName) {
                alert('請填寫所有使用者資訊！');
                return;
            }
            if (users.some(u => u.username === newUsername)) {
                alert('帳號已存在，請使用其他帳號！');
                return;
            }

            users.unshift({ // 新增到最前面
                username: newUsername,
                password: newPassword,
                fullname: newFullName,
                role: newUserRole
            });
            saveData();
            alert('新使用者新增成功！');
            addLog('新增使用者', `新增使用者: ${newFullName} (帳號: ${newUsername})`);
            renderUsers();
            closeModal('addUserModal');
        }

        // 開啟編輯使用者模態框
        function openEditUserModal(username) {
            const user = users.find(u => u.username === username);
            if (!user) return;

            document.getElementById('editUserOriginalUsername').value = user.username;
            document.getElementById('editUsername').value = user.username;
            document.getElementById('editPassword').value = ''; // 編輯時不顯示舊密碼，留空表示不更改
            document.getElementById('editFullName').value = user.fullname;
            document.getElementById('editUserRole').value = user.role;
            document.getElementById('editUserModal').style.display = 'block';
        }

        // 更新使用者
        function updateUser() {
            const originalUsername = document.getElementById('editUserOriginalUsername').value;
            const editUsername = document.getElementById('editUsername').value.trim(); // 帳號不可編輯
            const editPassword = document.getElementById('editPassword').value.trim();
            const editFullName = document.getElementById('editFullName').value.trim();
            const editUserRole = document.getElementById('editUserRole').value;

            if (!editUsername || !editFullName) {
                alert('請填寫使用者姓名！');
                return;
            }

            const userIndex = users.findIndex(u => u.username === originalUsername);
            if (userIndex !== -1) {
                if (editPassword) { // 如果有輸入新密碼才更新
                    users[userIndex].password = editPassword;
                }
                users[userIndex].fullname = editFullName;
                users[userIndex].role = editUserRole;
                saveData();
                alert('使用者資訊更新成功！');
                addLog('更新使用者', `更新使用者: ${editFullName} (帳號: ${editUsername})`);
                renderUsers();
                closeModal('editUserModal');
            }
        }

        // 刪除使用者
        function deleteUser(username) {
            if (confirm(`確定要刪除帳號 ${username} 嗎？此操作不可逆！`)) {
                if (users.length === 1) {
                    alert('不能刪除最後一個使用者！');
                    return;
                }
                users = users.filter(user => user.username !== username);
                saveData();
                alert('使用者已刪除！');
                addLog('刪除使用者', `刪除使用者帳號: ${username}`);
                renderUsers();
            }
        }

        // 渲染系統日誌
        function renderLogs() {
            const tableBody = document.getElementById('logTableBody');
            tableBody.innerHTML = '';
            if (logs.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="4" style="text-align: center;">目前沒有系統日誌。</td></tr>';
                return;
            }
            logs.forEach(log => {
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td>${log.timestamp}</td>
                    <td>${log.user}</td>
                    <td>${log.action}</td>
                    <td>${log.description}</td>
                `;
            });
        }

        // 下拉選單功能
        function toggleDropdown(dropdownId) {
            const dropdown = document.getElementById(dropdownId);
            dropdown.classList.toggle('show');
        }

        // 點擊外面關閉下拉選單
        window.onclick = function(event) {
            if (!event.target.matches('.dropdown-btn')) {
                const dropdowns = document.querySelectorAll('.dropdown-content');
                dropdowns.forEach(openDropdown => {
                    if (openDropdown.classList.contains('show')) {
                        openDropdown.classList.remove('show');
                    }
                });
            }
        }

        // 批量建立採購單功能
        let selectedProcurementItems = []; // 儲存選中請購單中的所有品項

        function updateSelectedCount() {
            const checkboxes = document.querySelectorAll('#approvedProcurementTable .approved-checkbox');
            let count = 0;
            checkboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    count++;
                }
            });
            document.getElementById('selectedCount').textContent = count;
        }

        function toggleAllApproved() {
            const selectAll = document.getElementById('selectAllCheckbox').checked;
            const checkboxes = document.querySelectorAll('#approvedProcurementTable .approved-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll;
            });
            updateSelectedCount();
        }

        function selectAllApproved() {
            document.getElementById('selectAllCheckbox').checked = true;
            toggleAllApproved();
        }

        function clearAllApproved() {
            document.getElementById('selectAllCheckbox').checked = false;
            toggleAllApproved();
        }

        function previewSelectedItems() {
            selectedProcurementItems = [];
            let totalPreviewAmount = 0;
            const checkboxes = document.querySelectorAll('#approvedProcurementTable .approved-checkbox:checked');
            if (checkboxes.length === 0) {
                alert('請至少選擇一個請購單來預覽。');
                return;
            }

            const previewTableBody = document.getElementById('previewSelectedItemsTableBody');
            previewTableBody.innerHTML = '';

            checkboxes.forEach(checkbox => {
                const row = checkbox.closest('tr');
                const procurementNo = row.dataset.procurementNo;
                const procurement = procurements.find(p => p.procurementNo === procurementNo);
                if (procurement) {
                    procurement.items.forEach(item => {
                        selectedProcurementItems.push({
                            procurementNo: procurement.procurementNo,
                            name: item.name,
                            spec: item.spec,
                            quantity: item.quantity,
                            unit: item.unit,
                            estimatedUnitPrice: item.estimatedUnitPrice,
                            subtotal: item.subtotal
                        });
                        totalPreviewAmount += item.subtotal;

                        const newRow = previewTableBody.insertRow();
                        newRow.innerHTML = `
                            <td>${procurement.procurementNo}</td>
                            <td>${item.name}</td>
                            <td>${item.spec}</td>
                            <td>${item.quantity}</td>
                            <td>${item.unit}</td>
                            <td>${item.estimatedUnitPrice.toFixed(2)}</td>
                            <td>${item.subtotal.toFixed(2)}</td>
                        `;
                    });
                }
            });

            document.getElementById('previewTotalAmount').textContent = totalPreviewAmount.toFixed(2);
            document.getElementById('previewSelectedItemsModal').style.display = 'block';
        }

        function confirmCreatePurchaseFromPreview() {
            if (selectedProcurementItems.length === 0) {
                alert('沒有選取的項目可供建立採購單。');
                return;
            }

            // 轉到建立採購單頁面，並預填入項目
            showPage('createPurchase');
            resetPurchaseForm(); // 先清空，再添加選中的項目

            const purchaseItemsTableBody = document.getElementById('purchaseItemsTableBody');
            let newPurchaseTotalAmount = 0;

            selectedProcurementItems.forEach(item => {
                const newRow = purchaseItemsTableBody.insertRow();
                newRow.innerHTML = `
                    <td><input type="text" value="" placeholder="品項編號 (選填)"></td>
                    <td><input type="text" value="${item.name}" placeholder="品項名稱"></td>
                    <td><input type="text" value="${item.spec}" placeholder="規格"></td>
                    <td><input type="number" min="1" value="${item.quantity}" onchange="calculatePurchaseSubtotal(this.parentNode.parentNode)"></td>
                    <td><input type="text" value="${item.unit}" placeholder="單位"></td>
                    <td><input type="number" min="0" step="0.01" value="${item.estimatedUnitPrice}" onchange="calculatePurchaseSubtotal(this.parentNode.parentNode)"></td>
                    <td class="subtotal">${item.subtotal.toFixed(2)}</td>
                    <td><button type="button" class="btn btn-danger btn-sm" onclick="deletePurchaseItem(this)">刪除</button></td>
                `;
                newPurchaseTotalAmount += item.subtotal;
            });
            document.getElementById('purchaseTotalAmount').textContent = newPurchaseTotalAmount.toFixed(2);

            // 清除選中的請購單，防止重複操作
            clearAllApproved();
            selectedProcurementItems = []; // 清空預覽數據
            closeModal('previewSelectedItemsModal');
            alert('已將選取項目自動帶入採購單！請確認後提交。');
            addLog('批量建立採購單', '從已核准請購單批量建立採購單。');
        }


        // 頁面加載時初始化
        document.addEventListener('DOMContentLoaded', () => {
            // 檢查是否已登入
            if (currentUser) {
                document.getElementById('currentUser').textContent = currentUser.fullname;
                document.getElementById('loginPage').style.display = 'none';
                document.getElementById('mainSystem').style.display = 'block';
                updateNavigationVisibility();
                showPage('newProcurement'); // 預設顯示新增請購
            } else {
                document.getElementById('loginPage').style.display = 'flex';
                document.getElementById('mainSystem').style.display = 'none';
            }
            updatePendingCount(); // 初始化待簽核計數
            generateProcurementNo(); // 生成初始請購單號
            document.getElementById('applyDate').valueAsDate = new Date(); // 設置初始日期
            generatePurchaseNo(); // 生成初始採購單號
            document.getElementById('purchaseDate').valueAsDate = new Date(); // 設置初始日期
        });
    </script>
</body>
</html>
